services:
  postgres:
    image: postgres:16-alpine
    container_name: smart-ingredients-db
    environment:
      POSTGRES_USER: smart_ingredients
      POSTGRES_PASSWORD: smart_ingredients
      POSTGRES_DB: smart_ingredients
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U smart_ingredients"]
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: smart-ingredients-backend
    environment:
      DATABASE_URL: postgresql://smart_ingredients:smart_ingredients@postgres:5432/smart_ingredients
      UPLOAD_DIR: /app/uploads

      # LLM (DeepSeek)
      LLM_PROVIDER: ${LLM_PROVIDER:-deepseek}
      LLM_TIMEOUT: ${LLM_TIMEOUT:-600}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:?set this in server env or a local .env file}
      DEEPSEEK_API_URL: ${DEEPSEEK_API_URL:-https://api.deepseek.com/v1/chat/completions}
      DEEPSEEK_MODEL: ${DEEPSEEK_MODEL:-deepseek-chat}

      # OCR: using PaddleOCR service
      OCR_LANG: ${OCR_LANG:-chi_sim+eng}
      OCR_TIMEOUT: ${OCR_TIMEOUT:-30}
      OCR_PADDLE_URL: ${OCR_PADDLE_URL:-http://ocr:8000/ocr}
      RULES_PATH: /app/rules.json
      RULES_REFRESH_SECONDS: 300
      SERVICE_NAME: ${SERVICE_NAME:-backend}
      DEPLOY_ENV: ${DEPLOY_ENV:-prod}
      RUST_LOG: ${RUST_LOG:-info}
    ports:
      - "3000:3000"
    volumes:
      - backend_uploads:/app/uploads
    depends_on:
      postgres:
        condition: service_healthy
      ocr:
        condition: service_started
    restart: unless-stopped

  ocr:
    build:
      context: .
      dockerfile: ocr_service/Dockerfile
    container_name: smart-ingredients-ocr
    environment:
      PADDLE_OCR_LANG: ch
      OCR_PREPROCESS_ENABLED: ${OCR_PREPROCESS_ENABLED:-true}
      OCR_RETRY_MAX: ${OCR_RETRY_MAX:-1}
      OCR_MIN_TEXT_LEN: ${OCR_MIN_TEXT_LEN:-2}
      OCR_PREPROCESS_THRESHOLD: ${OCR_PREPROCESS_THRESHOLD:-180}
      OCR_PREPROCESS_SCALE: ${OCR_PREPROCESS_SCALE:-1.5}
    restart: unless-stopped

volumes:
  postgres_data:
  backend_uploads:
