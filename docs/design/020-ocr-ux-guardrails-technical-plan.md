# 020-技术方案

## 元数据

| 字段     | 值                       |
| -------- | ------------------------ |
| 文档编号 | 020-ocr-ux-guardrails     |
| 标题     | OCR 质量提升与强提醒补充 技术方案 |
| 版本     | 1.0                      |
| 状态     | 草稿                     |
| 创建日期 | 2026-02-13               |
| 更新日期 | 2026-02-13               |
| 作者     | 小周                     |
| 关联需求 | 020-ocr-ux-guardrails     |

## 概述

### 目的
在现有 OCR + 规则兜底基础上，提升 OCR 输出稳定性，并将高风险规则命中结果以更强的 UI 方式呈现。

### 范围
- OCR 预处理与自动重试
- 规则命中强提醒区块
- 可信度来源解释增强

### 假设
- 继续使用 PaddleOCR 服务
- 规则 JSON 结构保持兼容

## 架构设计

### 高层架构
- 上传图片 → OCR 服务（预处理+重试）→ 规则引擎 → LLM → 前端展示

### 组件图
- OCR Service：增加预处理与重试
- Backend：聚合 OCR 状态与重试原因
- Frontend：新增强提醒区块

### 技术栈

| 组件   | 技术   | 选择理由   |
| ------ | ------ | ---------- |
| OCR    | PaddleOCR | 已集成，中文支持好 |
| 预处理 | Pillow/OpenCV（轻量） | 快速验证效果 |
| 前端   | React/Tauri | 现有栈 |

## 数据模型

### 实体
- OCR 结果增加 retry_count、retry_reason（可选）

### 数据流
- 后端调用 OCR：若空文本 → 重试 → 记录原因

## API 设计

### 接口列表

| 方法 | 路径 | 描述 | 请求 | 响应 |
| ---- | ---- | ---- | ---- | ---- |
| POST | /api/v1/analysis/upload | 上传 | 文件 | OCR 状态 |
| POST | /api/v1/analysis/:id/retry-ocr | 重试 | - | OCR 状态 |

### 数据结构
- 在 AnalysisResult 增加 retry_count、retry_reason（若不落库则仅日志）

## 错误处理

### 错误码
| 错误码 | 消息 | 描述 |
| ------ | ---- | ---- |
| OCR_EMPTY | OCR text length invalid | 空结果或过短 |

## 性能考虑

### 优化
- 预处理仅在空或过短时触发

## 测试策略

### 集成测试
- 低清晰度中文图像识别
- OCR 空结果自动重试

### E2E 测试
- 完整流程展示强提醒与可信度

## 部署

### 配置
- OCR_PREPROCESS_ENABLED
- OCR_RETRY_MAX

## 实施阶段

### 阶段 1：OCR 预处理与重试
- [ ] 添加预处理逻辑（灰度/二值化/放大）
- [ ] 空/过短文本自动重试

### 阶段 2：强提醒与解释性
- [ ] 前端新增强提醒区块
- [ ] 可信度来源与规则命中理由增强

## 风险与缓解

| 风险 | 影响 | 可能性 | 缓解措施 |
| ---- | ---- | ------ | -------- |
| 预处理导致误识别 | 中 | 中 | 可配置开关与回退 |
| 重试增加延迟 | 中 | 中 | 限制重试次数 |

## 待解决问题

| 问题 | 影响 | 负责人 | 状态 |
| ---- | ---- | ---- | ---- |
| 规则库是否扩展人群标签 | 中 | 小周 | 开放 |

## 参考资料

- 019 需求/技术方案

---

## 变更记录

| 版本 | 日期 | 作者 | 描述 |
| ---- | ---- | ---- | ---- |
| 1.0  | 2026-02-13 | 小周 | 初始版本 |
