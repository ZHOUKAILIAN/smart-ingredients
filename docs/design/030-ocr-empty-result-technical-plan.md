# 030-OCR 空结果失败提示 技术方案

## 元数据

| 字段     | 值                           |
| -------- | ---------------------------- |
| 文档编号 | 030-ocr-empty-result         |
| 标题     | OCR 空结果失败提示 技术方案 |
| 版本     | 1.0                          |
| 状态     | 草稿                         |
| 创建日期 | 2026-02-21                   |
| 更新日期 | 2026-02-21                   |
| 作者     | Codex                        |
| 关联需求 | 030-ocr-empty-result         |

## 概述

### 目的
在 OCR 无识别结果时返回业务失败（422）并提供友好提示，避免 500 影响全链路。

### 范围
- OCR 服务（FastAPI + PaddleOCR）
- 后端 OCR 调用与 OCR 状态落库
- 不改动前端页面与交互

### 假设
- OCR 服务与后端通过 HTTP 交互，后端可读取 OCR 响应体
- OCR 空结果是可判定的（PaddleOCR 可能返回 `None` 或空文本）

## 架构设计

### 高层架构
上传图片 → 后端触发 OCR → OCR 服务识别 → 返回文本或 422 → 后端更新状态。

### 组件图
- OCR 服务：`ocr_service/app.py`
- 后端 OCR 调用：`backend/src/services/ocr.rs`
- OCR 任务落库：`backend/src/handlers/analysis.rs`

### 技术栈

| 组件 | 技术 | 选择理由 |
|------|------|----------|
| OCR 服务 | FastAPI + PaddleOCR | 现有实现，中文效果好 |
| 后端 | Rust + Axum | 现有主服务 |

## 数据模型

### 实体
- `analyses`：已有 `ocr_status`、`error_message` 字段

### 数据流
1. OCR 服务收到图片
2. OCR 识别结果为空 → 返回 422 + message
3. 后端收到 422 → 写入 `ocr_failed` + `error_message`

## API 设计

### OCR 服务响应
- **成功**（保持不变）
  - `200 OK`
  - `{ "text": "...", "lines": [...] }`
- **空结果失败**（新增）
  - `422 Unprocessable Entity`
  - `{ "message": "未识别到文字，请重新拍摄或上传更清晰的图片" }`

### 后端对外接口
- 无新增/修改 API；返回的 `error_message` 在 `GET /api/v1/analysis/:id` 中可见。

## 错误处理

### OCR 服务
- 空结果返回 422 + message
- 避免 `NoneType` 遍历导致的 500

### 后端
- 当 OCR 响应状态为 422：
  - 尝试解析 JSON 的 `message` 或 `detail`
  - 解析失败时使用默认提示文案
  - 写入 `error_message` 并标记 `ocr_failed`
- 其他非 2xx 继续作为依赖失败处理

## 测试策略

### 单元/组件验证
- OCR 服务：使用空白图片验证返回 422 + message
- 后端：模拟 OCR 422 响应后确认 `ocr_failed` 与 `error_message`

### 集成测试
- 走完整上传 → OCR → 查询流程，确认前端拿到可读提示

## 部署

### 配置
- 无新增环境变量

### 回滚计划
- 回滚 OCR 服务与后端变更至前一版本

## 实施阶段

### 阶段 1：OCR 服务空结果处理
- [ ] 为 `result`/`block`/`item` 增加空值保护
- [ ] 空文本返回 422 + message

### 阶段 2：后端 422 处理
- [ ] 解析 OCR 422 响应体中的 message/detail
- [ ] 失败时写入 `ocr_failed` + `error_message`

### 阶段 3：验证
- [ ] OCR 空结果用例验证
- [ ] 全链路 API 验证

## 风险与缓解

| 风险 | 影响 | 可能性 | 缓解措施 |
|------|------|--------|----------|
| OCR 响应体格式不一致 | 中 | 中 | 解析失败走默认提示 |
| OCR 服务仍抛异常 | 中 | 低 | 增加空值保护与日志 |

## 待解决问题

| 问题 | 影响 | 负责人 | 状态 |
|------|------|--------|------|
| 默认提示文案是否需要产品确认 | 低 | 产品/设计 | 开放 |

## 变更记录

| 版本 | 日期 | 作者 | 描述 |
| ---- | ---- | ---- | ---- |
| 1.0 | 2026-02-21 | Codex | 初始版本 |
