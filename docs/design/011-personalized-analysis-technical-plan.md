# 011-个性化分析技术方案

## 元数据

| 字段     | 值                         |
| -------- | -------------------------- |
| 文档编号 | 011-001                    |
| 标题     | 配料表个性化分析技术方案   |
| 版本     | 1.0                        |
| 状态     | 草稿                       |
| 创建日期 | 2026-01-24                 |
| 更新日期 | 2026-01-24                 |
| 作者     | Codex                      |
| 关联需求 | 011-个性化分析需求文档     |

## 概述

### 目的

在现有 OCR -> LLM 分析流程中引入“分析偏好”参数，使 LLM 结果更聚焦用户关注点，并为后续偏好持久化与 UI 优化奠定数据结构基础。

### 范围

包含：

- Confirm 请求携带 `preference` 字段
- LLM prompt 根据偏好拼接指令
- 分析结果附带偏好摘要与关注成分列表

不包含（留待后续）：

- 全局偏好存储与设置页
- 偏好选择 UI 及结果高亮展示
- 偏好配置热更新

### 假设

- 用户体系将来会加入，本期不接入身份认证流程
- 偏好仅作为单次分析参数，但接口与数据结构预留落库扩展
- LLM 仍使用现有 DeepSeek 实现与 JSON 解析逻辑
- 不新增数据库字段，暂不持久化偏好

## 架构设计

### 高层架构

沿用现有链路：上传 -> OCR -> 确认 -> LLM。新增 `preference` 从前端 Confirm 请求传入，后端拼 prompt 后返回。

### 组件图

- 前端 Confirm 页：传入 `preference`
- shared 类型：`ConfirmRequest` / `AnalysisResult` 扩展
- 后端分析处理：读取偏好、构建 prompt、解析返回

### 技术栈

| 组件   | 技术                 | 选择理由                     |
| ------ | -------------------- | ---------------------------- |
| 前端   | Leptos + Tauri       | 现有项目栈，避免引入新框架   |
| 后端   | Axum + Tokio         | 已有服务，便于复用中间件     |
| LLM    | DeepSeek API         | 已接入，支持 prompt 调整     |
| 共享层 | Rust shared crate    | 统一类型定义，避免前后端不一致 |

## 数据模型

### 实体

无新增数据库实体，偏好仅在请求与响应中携带；预留后续 `user_preferences` 表进行持久化。

### 模式

偏好枚举（建议定义在 shared）：

```
enum PreferenceType {
  None,
  WeightLoss,
  Health,
  Fitness,
  Allergy,
  Kids,
}
```

ConfirmRequest 扩展：

```
pub struct ConfirmRequest {
  pub confirmed_text: String,
  pub preference: Option<String>,
}
```

AnalysisResult 扩展：

```
pub struct AnalysisResult {
  pub focus_summary: Option<String>,
  pub focus_ingredients: Option<Vec<String>>,
}
```

### 数据流

1. 前端 Confirm 调用发送 `preference`
2. 后端校验并规范化偏好（unknown -> none）
3. LLM prompt 拼接偏好指令
4. LLM 返回 JSON，解析 `focus_summary` / `focus_ingredients`
5. 前端展示结果（简化版不做高亮）
6. 未来接入用户体系后，可在登录时加载用户偏好并作为默认值

## API 设计

### 接口列表

| 方法 | 路径                               | 描述                     | 请求            | 响应               |
| ---- | ---------------------------------- | ------------------------ | --------------- | ------------------ |
| POST | `/api/v1/analysis/{id}/confirm`    | 确认 OCR 并触发 LLM 分析 | ConfirmRequest  | AnalysisResponse   |
| GET  | `/api/v1/analysis/{id}`            | 获取分析结果             | -               | AnalysisResponse   |

### 数据结构

- `ConfirmRequest.preference`：可选，字符串枚举
- `AnalysisResult.focus_summary`：偏好摘要
- `AnalysisResult.focus_ingredients`：偏好相关成分列表

## 评分标准与稳定性

### 评分原则

- 有偏好：按偏好维度生成评分项并加权汇总
- 无偏好：使用通用评分维度与权重
- LLM 只输出结构化评分项，最终分数由后端规则计算，确保稳定

### 通用评分维度（无偏好，维度归一）

统一为 5 个大类，模型输出子项说明即可：

| 维度         | 权重 | 子项示例                                                  |
| ------------ | ---- | --------------------------------------------------------- |
| 添加剂与加工 | 30%  | 防腐剂/色素/香精/增稠剂/超加工提示                         |
| 糖脂结构     | 30%  | 添加糖/总糖/反式脂肪酸/高脂提示                            |
| 营养价值     | 20%  | 蛋白质/膳食纤维/优质脂肪/营养密度                          |
| 特殊敏感     | 10%  | 过敏原/咖啡因/刺激性成分                                  |
| 配方复杂度   | 10%  | 添加剂数量/配料表长度/配方复杂度                          |

### 偏好评分维度（有偏好，权重调整）

- weight_loss：糖脂结构 45%，营养价值 20%，添加剂与加工 20%，特殊敏感 5%，配方复杂度 10%
- health：添加剂与加工 45%，糖脂结构 20%，营养价值 15%，特殊敏感 5%，配方复杂度 15%
- fitness：营养价值 45%，糖脂结构 20%，添加剂与加工 15%，特殊敏感 5%，配方复杂度 15%
- allergy：特殊敏感 60%，添加剂与加工 15%，糖脂结构 10%，营养价值 5%，配方复杂度 10%
- kids：添加剂与加工 40%，糖脂结构 30%，特殊敏感 15%，营养价值 5%，配方复杂度 10%

### LLM 输出结构（新增评分项）

在原有 JSON 结构上增加评分项，后端按规则加权计算：

```
{
  "score_breakdown": [
    { "dimension": "additives", "score": 80, "reason": "..." },
    { "dimension": "allergens", "score": 60, "reason": "..." }
  ]
}
```

### 稳定性策略

- 固定 prompt + 低温度（或默认 deterministic 配置）
- LLM 只给出各维度评分与理由，不直接生成最终总分
- 后端对评分项做边界裁剪（0-100），并使用固定权重计算

## 安全设计

### 认证

沿用现有方案，无新增认证流程。

### 授权

当前无用户体系，无新增授权逻辑。

### 数据保护

偏好仅是分析标签，不涉及敏感数据。

## 错误处理

### 错误码

| 错误码 | 消息                 | 描述                           |
| ------ | -------------------- | ------------------------------ |
| 400    | invalid preference   | preference 不在可选枚举内      |

### 错误响应格式

沿用现有 `AppError`/统一错误响应格式。

## 性能考虑

### 缓存策略

无新增缓存，复用现有分析缓存策略。

### 优化

偏好指令以短字符串拼接，控制 token 成本。

### 监控

沿用现有 LLM 调用日志与耗时指标。

## 结果展示排序规则

- 风险高的在上，健康/低风险在下
- 同一风险等级内，优先展示偏好相关的成分
- 最后一段展示“配料表综合分析/总结”

## 测试策略

### 单元测试

- 偏好字符串 -> 枚举映射
- Prompt 生成包含偏好指令
- JSON 解析包含新增字段

### 集成测试

- Confirm 请求携带 `preference` 后正常返回

### E2E 测试

- 后续 UI 完整上线后补充

## 部署

### 环境要求

无新增依赖。

### 配置

无新增配置项。

### 回滚计划

若出现异常，可移除新增字段并回退到原有 prompt。

## 实施阶段

### 阶段 1：共享类型与后端支持

- [ ] 扩展 `shared::ConfirmRequest` 与 `shared::AnalysisResult`
- [ ] 后端读取 `preference` 并标准化
- [ ] prompt 拼接偏好指令
- [ ] 解析 `focus_summary` / `focus_ingredients`

### 阶段 2：前端请求适配

- [ ] Confirm 请求传入默认 `preference`（暂用 none）
- [ ] 前端兼容新增返回字段

### 阶段 3：后续增强（非本期）

- [ ] 偏好选择 UI 与全局存储
- [ ] 接入用户体系后偏好落库（user_preferences）
- [ ] 结果高亮与偏好切换
- [ ] 配置热更新

## 风险与缓解

| 风险                     | 影响 | 可能性 | 缓解措施                         |
| ------------------------ | ---- | ------ | -------------------------------- |
| LLM 返回字段缺失          | 中   | 中     | 解析默认空值，保持兼容           |
| preference 乱传导致错误   | 低   | 中     | 后端统一规范化，未知值回退 none  |
| Prompt 增长影响响应时间   | 低   | 低     | 控制偏好指令长度                 |
| 用户体系接入后迁移复杂    | 中   | 中     | 预留表结构与接口字段，减少改动   |

## 待解决问题

| 问题                         | 影响 | 负责人 | 状态 |
| ---------------------------- | ---- | ------ | ---- |
| 是否需要落库保存 preference  | 中   | 待定   | 开放 |
| 用户体系设计与偏好表结构     | 高   | 待定   | 开放 |
| 偏好 UI 交互方式与入口       | 中   | 待定   | 开放 |
| 不同偏好下的展示高亮规则     | 中   | 待定   | 开放 |

## 参考资料

- `docs/requirements/011-personalized-analysis-requirements.md`
- `docs/design/implementation-plan.md`
- `docs/standards/technical-design-template.md`

---

## 变更记录

| 版本 | 日期       | 作者  | 描述     |
| ---- | ---------- | ----- | -------- |
| 1.1  | 2026-01-24 | Codex | 补充结果排序与展示规则 |
| 1.0  | 2026-01-24 | Codex | 初始版本 |
