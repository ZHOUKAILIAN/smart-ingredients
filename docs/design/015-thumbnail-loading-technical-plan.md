# 015-缩略图加载技术方案

## 元数据

| 字段     | 值                               |
| -------- | -------------------------------- |
| 文档编号 | 015-thumbnail-loading            |
| 标题     | 缩略图加载技术方案               |
| 版本     | 1.0                              |
| 状态     | 草稿                             |
| 创建日期 | 2026-01-26                       |
| 更新日期 | 2026-01-26                       |
| 作者     | Codex                            |
| 关联需求 | 015-thumbnail-loading            |

## 概述

### 目的

为图片缩略图/预览提供加载反馈，避免加载过程中出现“无响应”体验，确保加载完成或失败后状态可恢复。

### 范围

- 前端缩略图/预览组件加载状态管理。
- UI 样式层遮罩与 spinner 表现。
- 失败态回退（先关闭 loading，后续可扩展占位图或提示）。

### 假设

- 现有前端已使用 Leptos，并具备统一样式文件 `app.css`。
- 图片预览使用 `blob:` URL 或远端 URL，均可通过 `onload/onerror` 触发状态变更。

## 架构设计

### 高层架构

仅涉及前端视图层与组件状态，不影响后端与 API。

### 组件图

- 前端
  - `ImagePreview`：加载状态维护与事件绑定
  - `app.css`：遮罩与 spinner 样式

### 技术栈

| 组件   | 技术                 | 选择理由             |
| ------ | -------------------- | -------------------- |
| 前端   | Leptos               | 现有框架一致         |
| 样式   | CSS                  | 复用现有样式与动画   |

## 数据模型

### 实体

- 图片加载状态：用于控制 loading 遮罩显示。

### 模式

```rust
struct ImagePreviewState {
  is_loading: bool,
}
```

### 数据流

1) `preview_url` 变更为 `Some` → `is_loading = true`
2) `<img>` 触发 `onload/onerror` → `is_loading = false`
3) 根据 `is_loading` 切换 `loading` class 与遮罩显示

## API 设计

无需新增或修改 API。

## 安全设计

- 无新增权限与鉴权改动。
- 不涉及用户数据采集或存储。

## 错误处理

### 错误场景

- 图片加载失败（断链/格式异常/资源不可用）。

### 处理策略

- 关闭 loading 遮罩，避免卡死。
- 后续可扩展占位图或重试按钮（不在本次范围）。

## 性能考虑

- loading 状态只在预览期间短暂存在，不引入额外计算开销。
- 复用现有 `spin` 动画，不新增外部依赖。

## 测试策略

### 手工验证

- 选择图片后预览区域出现 loading，加载完成自动消失。
- 快速切换图片时 loading 状态正确重置。
- 断链图片触发 `onerror` 后 loading 关闭。

## 部署

### 环境要求

- 无新增构建依赖。

### 配置

- 无新增配置项。

### 回滚计划

- 删除 loading 遮罩 DOM 与样式。
- 移除 `is_loading` 状态与事件绑定。

## 实施阶段

### 阶段 1：前端组件与样式

- [ ] `ImagePreview` 增加 `is_loading` 状态与 `onload/onerror` 绑定
- [ ] `app.css` 增加遮罩与 spinner 样式
- [ ] 手工验证交互与失败态
