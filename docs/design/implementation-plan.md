# Implementation Plan - Smart Ingredients

## Phase 1: 基础设施 (Week 1)

### 001 数据库迁移需求
创建数据库表结构和初始迁移文件。

**表结构**:
- `analyses` - 分析记录表
- `ingredients` - 配料信息表
- `favorites` - 收藏表

**验收**:
- [ ] 迁移文件创建完成
- [ ] SQLx 编译检查通过

---

### 002 数据库连接需求
后端启动时自动连接数据库并管理连接池。

**验收**:
- [ ] 启动时成功连接 PostgreSQL
- [ ] 连接池配置正确

---

### 003 错误处理需求
实现统一的错误处理和响应格式。

**验收**:
- [ ] 所有错误类型实现 IntoResponse
- [ ] 错误响应格式符合 API 规范
- [ ] 请求 ID 中间件生效

---

### 004 健康检查需求
实现服务健康检查端点。

**验收**:
- [ ] `/health` 端点返回正确状态
- [ ] 检查数据库连接状态
- [ ] 检查 Redis 连接状态

---

### 005 Tauri 配置需求
配置 Tauri 桌面应用的基础设置。

**验收**:
- [ ] tauri.conf.json 配置正确
- [ ] 构建脚本创建完成

---

### 006 前端路由需求
实现前端页面路由系统。

**验收**:
- [ ] 路由系统正常工作
- [ ] 所有页面可访问
- [ ] 404 页面处理

---

### 007 基础页面组件需求
创建首页和基础页面组件。

**验收**:
- [ ] Home 页面渲染
- [ ] Upload 页面渲染
- [ ] Processing 页面渲染
- [ ] Result 页面渲染
- [ ] History 页面渲染

---

### 008 基础 UI 组件需求
创建可复用的基础 UI 组件。

**验收**:
- [ ] Button 组件
- [ ] Card 组件
- [ ] LoadingSpinner 组件
- [ ] HealthScore 组件

---

## Phase 2: 核心功能 (Week 2-3)

### 009 图片上传需求
用户可以上传图片到后端进行分析。

**后端验收**:
- [ ] 支持 multipart/form-data 上传
- [ ] 验证文件类型 (JPEG, PNG, WebP)
- [ ] 验证文件大小 (< 10MB)
- [ ] 生成唯一文件名
- [ ] 返回图片 URL

**前端验收**:
- [ ] 相机功能正常
- [ ] 相册选择正常
- [ ] 图片预览显示
- [ ] 上传进度显示
- [ ] 错误处理和重试

**API 设计**:
```
POST /api/v1/analysis/upload
Content-Type: multipart/form-data

Response 201:
{
  "id": "uuid",
  "status": "pending",
  "image_url": "https://..."
}
```

---

### 010 OCR 识别需求
从上传的图片中提取文字内容。

**阶段 1: tesseract-rs (快速验证)**
- 优点: 集成简单，无需额外服务
- 缺点: 中文识别准确率一般

**阶段 2: PaddleOCR 服务 (生产环境)**
- 优点: 高准确率，中文优化
- 缺点: 需要独立服务

**验收**:
- [ ] OCR 能正确识别中文
- [ ] 处理各种图片格式
- [ ] 返回结构化文本
- [ ] 失败时有重试机制

**API 设计**:
```
GET /api/v1/analysis/{id}

Response 200:
{
  "id": "uuid",
  "status": "processing",
  "ocr_text": "配料表：水、小麦粉、...",
  "result": null,
  "created_at": "2024-01-01T00:00:00Z"
}
```

---

### 011 LLM 分析需求
调用 LLM API 分析配料并返回健康评估。

**验收**:
- [ ] API 调用成功
- [ ] 返回正确的 JSON 格式
- [ ] 健康评分在 0-100 范围内
- [ ] 配料分类正确

**提示词设计**:
```
你是一个食品配料分析专家。请分析以下配料表：

配料表：{ocr_text}

请返回 JSON 格式：
{
  "health_score": 0-100,
  "ingredients": [
    {
      "name": "配料名称",
      "category": "additive/allergen/nutrition",
      "risk_level": "low/medium/high",
      "description": "说明"
    }
  ],
  "warnings": [
    {
      "warning_type": "类型",
      "ingredients": ["配料1", "配料2"],
      "message": "警告信息"
    }
  ],
  "recommendation": "整体建议"
}
```

---

## Phase 3: 结果展示 (Week 4)

### 012 结果页面展示需求
清晰展示分析结果和健康评分。

**后端验收**:
- [ ] GET `/api/v1/analysis/{id}` 返回完整结果
- [ ] POST `/api/v1/analysis/{id}/favorite` 收藏功能
- [ ] DELETE `/api/v1/analysis/{id}/favorite` 取消收藏

**前端验收**:
- [ ] 健康评分组件正确显示
- [ ] 配料列表按风险分组
- [ ] 警告横幅正确显示
- [ ] 操作按钮功能正常

---

### 013 历史记录需求
用户可以查看和管理历史分析记录。

**后端验收**:
- [ ] GET `/api/v1/analysis/history` 返回列表
- [ ] 支持分页参数
- [ ] 支持排序和筛选

**前端验收**:
- [ ] 历史列表正常显示
- [ ] 缩略图和评分显示
- [ ] 搜索功能正常
- [ ] 排序功能正常
- [ ] 收藏标记正常

**API 设计**:
```
GET /api/v1/analysis/history?page=1&limit=20&sort=score

Response 200:
{
  "total": 100,
  "page": 1,
  "limit": 20,
  "items": [...]
}
```

---

## Phase 4: 优化和部署 (Week 5-6)

### 014 缓存机制需求
实现 Redis 缓存提升性能。

**验收**:
- [ ] 分析结果缓存生效
- [ ] TTL 设置正确 (1小时)
- [ ] 缓存失效机制正常

---

### 015 性能优化需求
优化系统整体性能。

**验收**:
- [ ] 图片上传 < 2s
- [ ] OCR 处理 < 5s
- [ ] LLM 分析 < 10s
- [ ] 总响应时间 < 20s
- [ ] 数据库查询优化

---

### 016 错误处理完善需求
完善错误处理和用户提示。

**验收**:
- [ ] 所有错误有友好提示
- [ ] 重试机制正常
- [ ] 错误日志完整
- [ ] 结构化日志输出

---

### 017 部署配置需求
配置生产环境部署。

**验收**:
- [ ] Docker 镜像构建成功
- [ ] 前端打包脚本完成
- [ ] CI/CD 配置完成
- [ ] 环境变量配置文档完整

---

## 优先级排序

### P0 (必须完成)
1. 001 数据库迁移
2. 002 数据库连接
3. 003 错误处理
4. 004 健康检查
5. 005 Tauri 配置
6. 006 前端路由
7. 007 基础页面组件
8. 008 基础 UI 组件

### P1 (重要)
1. 009 图片上传
2. 010 OCR 识别
3. 011 LLM 分析
4. 012 结果页面展示
5. 013 历史记录

### P2 (优化)
1. 014 缓存机制
2. 015 性能优化
3. 016 错误处理完善
4. 017 部署配置

---

## 技术依赖

### 后端新增
```toml
[dependencies]
tesseract = "0.15"           # OCR (阶段1)
reqwest = { version = "0.12", features = ["json"] }  # LLM API
```

### 前端新增
```toml
[dependencies]
leptos-router = "0.7"      # 路由
```

### 环境变量
```bash
# LLM
LLM_API_KEY=your_deepseek_key
LLM_API_URL=https://api.deepseek.com/v1

# OCR (阶段2)
OCR_SERVICE_URL=http://localhost:5000
```

---

## 验收标准

### 功能验收
- [ ] 用户可以拍照上传图片
- [ ] OCR 能正确识别中文配料表
- [ ] LLM 能返回准确的健康评分
- [ ] 结果页面清晰展示分析结果
- [ ] 历史记录可以查看和搜索

### 性能验收
- [ ] 图片上传 < 2s
- [ ] OCR 处理 < 5s
- [ ] LLM 分析 < 10s
- [ ] 总响应时间 < 20s

### 质量验收
- [ ] 所有代码通过 clippy 检查
- [ ] 测试覆盖率 > 70%
- [ ] 无内存泄漏
- [ ] 错误日志完整

---

## 下一步行动

选择一个需求编号开始实现：

**Phase 1** (建议顺序):
1. 001 数据库迁移
2. 002 数据库连接
3. 003 错误处理
4. 004 健康检查
5. 005 Tauri 配置
6. 006 前端路由
7. 007 基础页面组件
8. 008 基础 UI 组件

建议从 001 开始，按顺序完成 Phase 1 的所有需求，确保基础稳固后再开发核心功能。
