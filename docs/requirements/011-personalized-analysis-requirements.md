# 011-个性化分析需求文档

## 元数据

| 字段     | 值                       |
| -------- | ------------------------ |
| 文档编号 | 011-001                  |
| 标题     | 配料表个性化分析需求文档 |
| 版本     | 1.0                      |
| 状态     | 草稿                     |
| 创建日期 | 2026-01-24               |
| 更新日期 | 2026-01-24               |
| 作者     | Claude Code              |

## 概述

### 背景

当前的配料表分析功能对所有用户提供统一的分析结果，缺乏针对性。不同用户群体关注的重点不同：

- 减肥人群更关注脂肪、热量、糖分
- 健康养生人群更关注添加剂、防腐剂、人工成分
- 健身人群更关注蛋白质、碳水化合物
- 过敏体质人群更关注过敏原
- 儿童家长更关注色素、香精等添加剂

统一的分析结果无法满足不同用户的个性化需求，导致用户体验不佳。

### 目的

提供个性化的配料表分析功能，允许用户选择自己的关注点（分析偏好），系统根据用户偏好提供针对性的分析结果，突出用户关心的信息，提升分析的实用性和用户满意度。

### 范围

**包含**:

- 用户分析偏好的定义与选择机制
- 基于偏好的个性化分析逻辑
- 针对不同偏好的分析结果展示
- 偏好配置的持久化存储

**不包含**（留待后续）:

- 用户自定义分析维度（仅支持预设偏好）
- 多偏好组合分析（一次仅支持一个偏好）
- 基于用户历史行为的智能推荐
- 社区分享与偏好模板

### 利益相关者

- 终端用户（获得个性化分析体验）
- 产品经理（提升产品差异化竞争力）
- 前端开发者（实现偏好选择与结果展示）
- 后端开发者（实现个性化分析逻辑）
- LLM 提示工程师（优化不同偏好的提示词）

## 功能需求

### 需求 1：分析偏好定义

- **编号**: FR-PERSO-001
- **优先级**: 高
- **描述**: 定义系统支持的分析偏好类型，每种偏好对应不同的分析侧重点
- **验收标准**:
  - [ ] 支持至少 5 种预设偏好：减肥、健康、健身、过敏、儿童
  - [ ] 每种偏好有明确的关注维度定义（如减肥关注：脂肪、热量、糖分、反式脂肪酸）
  - [ ] 偏好配置可扩展，便于后续新增其他偏好类型
  - [ ] 每种偏好有友好的名称、描述和图标标识

### 需求 2：偏好选择界面

- **编号**: FR-PERSO-002
- **优先级**: 高
- **描述**: 用户可以在分析前选择自己的分析偏好
- **验收标准**:
  - [ ] 首次使用时引导用户选择偏好
  - [ ] 提供清晰的偏好选择界面（卡片式或列表式）
  - [ ] 每个偏好有简短说明，帮助用户理解其含义
  - [ ] 支持"暂不选择"选项，使用默认通用分析
  - [ ] 选择后可在设置中修改偏好

### 需求 3：个性化分析逻辑

- **编号**: FR-PERSO-003
- **优先级**: 高
- **描述**: 采用 "全局预设 + 临时覆盖" 策略。系统根据用户预设的全局偏好自动进行 targeted 分析，同时允许在单次分析中临时调整。
- **验收标准**:
  - [ ] 提供全局偏好设置入口（如：设置页面），一次设置，永久生效
  - [ ] 分析请求（ConfirmRequest）需携带当前的 `preference` 参数（默认为全局设置值）
  - [ ] 在确认 OCR 文本的界面提供 "分析视角" 下拉选项，允许用户临时修改本次分析的偏好
  - [ ] LLM 根据传入的具体偏好生成完全定制化的分析结果（非通用结果）

### 需求 4：个性化结果展示

- **编号**: FR-PERSO-004
- **优先级**: 高
- **描述**: 分析结果界面根据偏好调整展示优先级和样式
- **验收标准**:
  - [ ] 用户关注的成分在表格中高亮显示
  - [ ] 摘要区域优先展示偏好相关信息
  - [ ] 提供"为什么推荐/不推荐"的个性化说明
  - [ ] 显示当前使用的分析偏好标签
  - [ ] 支持快速切换偏好重新分析

### 需求 5：偏好持久化

- **编号**: FR-PERSO-005
- **优先级**: 中
- **描述**: 用户的偏好选择需要持久化存储，下次使用时自动应用
- **验收标准**:
  - [ ] 偏好保存在本地存储（前端）或用户配置表（后端）
  - [ ] 应用启动时自动加载用户偏好
  - [ ] 支持偏好的更新和重置
  - [ ] 偏好数据结构支持版本迁移

### 需求 6：偏好分析示例

- **编号**: FR-PERSO-006
- **优先级**: 中
- **描述**: 为每种偏好提供示例分析，帮助用户理解不同偏好的效果
- **验收标准**:
  - [ ] 偏好选择界面提供"查看示例"功能
  - [ ] 示例展示同一配料表在不同偏好下的分析差异
  - [ ] 示例清晰标注不同偏好的关注重点

## 非功能需求

### 性能

- 偏好选择不增加额外的页面跳转负担
- 定制化分析与通用分析的 LLM 响应时间差异需 < 5%

### 可用性

- 偏好选择界面简洁直观，新用户无需说明即可理解
- 支持无障碍访问（屏幕阅读器友好）

### 可扩展性

- 偏好配置支持热更新，无需发版即可新增偏好
- LLM 提示词模板化，便于调整和优化

### 兼容性

- 未选择偏好的用户保持现有分析逻辑不变
- 支持从通用分析平滑迁移到个性化分析

## 用户故事

### 故事 1：减肥用户

- **作为** 一名正在减肥的用户
- **我想要** 选择"减肥"偏好进行配料表分析
- **以便** 快速了解食品的脂肪、热量和糖分含量，避免选择高热量食品

### 故事 2：健康养生用户

- **作为** 一名注重健康的中年用户
- **我想要** 选择"健康"偏好进行配料表分析
- **以便** 重点查看添加剂、防腐剂等人工成分，选择更天然的食品

### 故事 3：儿童家长

- **作为** 一名为孩子选购零食的家长
- **我想要** 选择"儿童"偏好进行配料表分析
- **以便** 了解食品中是否含有色素、香精等对儿童不利的成分

### 故事 4：健身人群

- **作为** 一名健身爱好者
- **我想要** 选择"健身"偏好进行配料表分析
- **以便** 快速查看蛋白质含量和碳水化合物类型，选择适合增肌的食品

### 故事 5：过敏体质用户

- **作为** 一名对某些成分过敏的用户
- **我想要** 选择"过敏"偏好进行配料表分析
- **以便** 快速识别常见过敏原（如花生、乳制品、麸质），避免过敏风险

## 用例

### 用例 1：首次使用选择偏好

- **参与者**: 新用户
- **前置条件**: 用户首次打开应用
- **主流程**:
  1. 应用检测到用户未设置偏好
  2. 显示偏好选择引导页
  3. 展示所有可用偏好及其说明
  4. 用户选择一个偏好（或选择"暂不选择"）
  5. 系统保存用户选择
  6. 进入主界面，应用用户偏好
- **后置条件**: 用户偏好已保存，后续分析自动应用该偏好
- **备选流程**: 用户选择"暂不选择"，系统使用默认通用分析

### 用例 2：切换偏好重新分析

- **参与者**: 已有偏好的用户
- **前置条件**: 用户已完成一次配料表分析
- **主流程**:
  1. 用户在分析结果页点击"切换偏好"
  2. 显示偏好选择弹窗
  3. 用户选择新的偏好
  4. 系统使用新偏好重新调用 LLM 分析
  5. 更新分析结果展示
- **后置条件**: 分析结果根据新偏好更新，用户偏好设置更新
- **备选流程**: 用户取消切换，保持当前偏好和结果

### 用例 3：在设置中修改偏好

- **参与者**: 任意用户
- **前置条件**: 用户进入设置页面
- **主流程**:
  1. 用户点击"分析偏好"设置项
  2. 显示当前偏好和所有可选偏好
  3. 用户选择新的偏好
  4. 系统保存新偏好
  5. 提示用户"下次分析将使用新偏好"
- **后置条件**: 用户偏好已更新，下次分析自动应用
- **备选流程**: 用户点击"重置为默认"，清除偏好设置

## 预设偏好详细定义

### 1. 减肥偏好（Weight Loss）

**关注维度**:

- 热量（能量）
- 脂肪（总脂肪、饱和脂肪、反式脂肪酸）
- 糖分（添加糖、总糖）
- 碳水化合物（特别是精制碳水）

**风险评级调整**:

- 高脂肪、高糖成分风险等级提升
- 代糖、膳食纤维成分风险等级降低

**分析侧重点**:

- 是否为高热量食品
- 隐藏的高糖高脂成分
- 是否含有代糖替代品
- 饱腹感相关成分

### 2. 健康偏好（Health）

**关注维度**:

- 添加剂（防腐剂、色素、香精、增稠剂）
- 人工成分 vs 天然成分
- 反式脂肪酸
- 钠含量

**风险评级调整**:

- 人工添加剂风险等级提升
- 天然成分风险等级降低

**分析侧重点**:

- 添加剂种类和数量
- 是否含有争议性添加剂
- 天然成分占比
- 加工程度评估

### 3. 健身偏好（Fitness）

**关注维度**:

- 蛋白质（含量、类型、来源）
- 碳水化合物（类型、GI 值）
- 脂肪（优质脂肪 vs 劣质脂肪）
- 电解质（钠、钾）

**风险评级调整**:

- 高蛋白成分风险等级降低
- 优质碳水（如燕麦、糙米）风险等级降低

**分析侧重点**:

- 蛋白质含量是否充足
- 碳水类型是否适合运动
- 是否含有支链氨基酸等健身相关成分
- 营养密度评估

### 4. 过敏偏好（Allergy）

**关注维度**:

- 常见过敏原（花生、树坚果、乳制品、鸡蛋、大豆、小麦、鱼类、贝类）
- 隐藏的过敏原成分
- 交叉污染风险提示

**风险评级调整**:

- 任何过敏原成分风险等级设为最高

**分析侧重点**:

- 明确标注所有过敏原
- 识别隐藏过敏原（如酪蛋白、乳清蛋白）
- 提供"可能含有"警告

### 5. 儿童偏好（Kids）

**关注维度**:

- 人工色素（如柠檬黄、胭脂红）
- 人工香精
- 防腐剂
- 糖分
- 咖啡因

**风险评级调整**:

- 人工色素、香精风险等级提升
- 高糖成分风险等级提升
- 含咖啡因成分风险等级设为最高

**分析侧重点**:

- 是否含有不适合儿童的添加剂
- 糖分是否过高
- 是否含有刺激性成分
- 是否为"儿童友好"配方

## 约束条件

### 技术约束

- LLM 提示词长度限制（需优化提示词效率）
- 前端存储空间限制（偏好配置需精简）

### 业务约束

- 偏好定义需基于科学依据，避免误导用户
- 不提供医疗建议，仅作为参考信息

### 法规约束

- 分析结果需符合食品标签法规
- 不夸大或贬低特定成分的作用

## 技术实现策略 (优化项)

### 1. "全局预设 + 临时覆盖" 架构 (Select-First Strategy)

核心理念是**减少用户决策成本**，同时保持灵活性。

**核心逻辑**:

1. **Global State**: 前端持久化存储用户的 `user_preference` (如 "weight_loss")。
2. **Request Flow**:
   - 用户上传图片 -> 识别文本。
   - **自动填充**: 确认框默认选中用户的全局偏好。
   - **临时修正**: 用户也可以手动切成 "kids"（为了给孩子看）。
   - **API 调用**: 后端接收单一明确的意图 `preference="kids"`。
3. **LLM Execution**: 后端根据意图动态构建 Prompt（例如插入：“请作为一名儿科营养专家，严查咖啡因和色素...”）。

**优势**:

- **精准度高**: LLM 角色扮演更专注，避免生成大而全但平庸的回答。
- **Token 节省**: 只生成用户关心的那个维度的深度分析，不浪费 Token 在无关维度上。
- **符合直觉**: 用户的身份通常是固定的（正在减肥就是正在减肥），不需要每次都从头选。

## 依赖关系

### 内部依赖

- 现有 LLM 分析流程（需扩展支持偏好参数）
- 配料表数据结构（需支持偏好标记）
- 用户配置管理模块（需支持偏好存储）

### 外部依赖

- LLM API 支持动态提示词调整
- 无新增第三方服务依赖

## 成功指标

- [ ] 用户偏好选择率 > 60%（首次使用用户）
- [ ] 偏好切换功能使用率 > 20%（活跃用户）
- [ ] 用户对个性化分析结果满意度 > 80%
- [ ] 不同偏好下分析结果差异明显（通过 A/B 测试验证）
- [ ] 个性化分析不增加超过 10% 的 LLM 调用时间

## 待解决问题

| 问题                                                                       | 影响 | 负责人 | 状态 |
| -------------------------------------------------------------------------- | ---- | ------ | ---- |
| 如何平衡不同偏好下的风险评级标准？                                         | 中   | 待定   | 开放 |
| 是否支持用户自定义偏好（如"低钠"、"低碳水"）？                             | 低   | 待定   | 开放 |
| 偏好是否支持多选（如同时关注减肥和健康）？                                 | 中   | 待定   | 开放 |
| 如何处理偏好与实际配料表信息不匹配的情况（如减肥偏好但配料表无营养成分）？ | 高   | 待定   | 开放 |
| 是否需要为不同地区提供本地化的偏好定义？                                   | 低   | 待定   | 开放 |

## 参考资料

- 食品标签相关法规
- 常见过敏原清单
- 营养学基础知识
- 竞品分析（如薄荷健康、Keep 等应用的个性化功能）

---

## 变更记录

| 版本 | 日期       | 作者        | 描述     |
| ---- | ---------- | ----------- | -------- |
| 1.0  | 2026-01-24 | Claude Code | 初始版本 |
