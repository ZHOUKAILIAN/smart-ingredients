# 012-用户体系需求文档

> ⚠️ 已废弃：登录体系已改为“账号 + 密码”，请以 `018-username-password-login-requirements.md` 为准。

## 元数据

| 字段 | 值 |
|------|-----|
| 文档编号 | 012-user-system |
| 标题 | 用户体系需求文档 |
| 版本 | 1.0 |
| 状态 | 草稿 |
| 创建日期 | 2026-01-25 |
| 更新日期 | 2026-01-25 |
| 作者 | Claude Code |

## 概述

### 目的

为 Smart Ingredients 应用引入用户体系，支持用户登录、偏好设置持久化和历史记录管理，同时保持应用的易用性（允许未登录用户使用核心功能）。

### 范围

**包含**：
- 用户注册与登录（手机号 + 验证码）
- 可选登录（未登录用户可使用核心功能）
- 用户偏好云端同步
- 分析历史记录管理
- 用户个人中心

**不包含**：
- 社交登录（微信、Apple ID 等）
- 用户之间的社交功能
- 付费会员体系
- 第三方账号绑定

### 利益相关者

- **终端用户**：希望保存分析历史、跨设备同步偏好
- **产品团队**：需要用户数据以优化产品
- **开发团队**：需要清晰的技术规范

## 功能需求

### 需求 1：可选登录机制

- **编号**: FR-001
- **优先级**: 高
- **描述**: 应用应支持未登录用户使用核心功能（拍照、OCR、分析），但部分功能（历史记录、偏好同步）需要登录后才能使用
- **验收标准**:
  - [ ] 未登录用户可以拍照并分析配料表
  - [ ] 未登录用户可以临时查看当前分析结果
  - [ ] 未登录用户在访问历史记录时显示登录引导
  - [ ] 登录后自动同步本地偏好到云端

### 需求 2：手机号验证码登录

- **编号**: FR-002
- **优先级**: 高
- **描述**: 用户通过手机号 + 验证码方式登录，无需密码
- **验收标准**:
  - [ ] 用户输入手机号后可请求验证码
  - [ ] 验证码 60 秒后可重新发送
  - [ ] 验证码 5 分钟内有效
  - [ ] 验证码错误 5 次后锁定 15 分钟
  - [ ] 首次登录自动创建用户账号
  - [ ] 登录后生成 JWT token（有效期 30 天）

### 需求 3：用户偏好数据库存储

- **编号**: FR-003
- **优先级**: 高
- **描述**: 用户的分析偏好（减肥、健康、健身等）应存储在数据库中，与用户账号关联，支持跨设备同步
- **验收标准**:
  - [ ] 未登录用户：偏好仅保存在 LocalStorage（临时）
  - [ ] 登录用户：偏好存储在数据库 `user_preferences` 表
  - [ ] 登录后自动从数据库加载偏好
  - [ ] 修改偏好后自动更新数据库
  - [ ] LocalStorage 作为缓存层，优先读取本地缓存
  - [ ] 登录时将本地偏好同步到数据库（如果本地偏好更新）
  - [ ] 支持未来扩展多偏好配置

### 需求 4：分析历史记录

- **编号**: FR-004
- **优先级**: 高
- **描述**: 登录用户可以查看、搜索和管理自己的分析历史记录
- **验收标准**:
  - [ ] 显示历史记录列表（按时间倒序）
  - [ ] 每条记录显示：缩略图、健康评分、分析时间
  - [ ] 支持点击查看历史记录详情
  - [ ] 支持删除单条历史记录
  - [ ] 支持批量删除历史记录
  - [ ] 分页加载（每页 20 条）
  - [ ] 未登录用户访问时显示登录引导

### 需求 5：个人中心

- **编号**: FR-005
- **优先级**: 中
- **描述**: 用户可以查看和管理个人信息
- **验收标准**:
  - [ ] 显示用户手机号（脱敏显示）
  - [ ] 显示注册时间
  - [ ] 显示分析次数统计
  - [ ] 支持退出登录
  - [ ] 支持注销账号（需二次确认）

### 需求 6：登录状态持久化

- **编号**: FR-006
- **优先级**: 高
- **描述**: 用户登录后，应用重启或刷新后仍保持登录状态
- **验收标准**:
  - [ ] JWT token 存储在 LocalStorage
  - [ ] 应用启动时自动验证 token 有效性
  - [ ] token 过期时自动跳转登录页
  - [ ] 支持 token 自动刷新（过期前 3 天）

## 非功能需求

### 性能

- 登录接口响应时间 < 500ms
- 验证码发送时间 < 3s
- 历史记录列表加载时间 < 1s（20 条）
- 偏好同步时间 < 300ms

### 安全性

- 验证码通过短信服务发送（不在前端生成）
- JWT token 使用 HS256 算法签名
- 手机号加密存储（AES-256）
- API 接口支持 HTTPS
- 防止验证码暴力破解（频率限制）
- 敏感操作（注销账号）需要二次验证

### 可靠性

- 验证码发送成功率 > 99%
- 登录成功率 > 99.9%
- 偏好同步成功率 > 99.5%

### 可扩展性

- 支持 10 万注册用户
- 支持 1 万并发登录请求
- 历史记录支持单用户 1000+ 条记录

## 用户故事

### 故事 1：首次使用无需登录

- **作为** 新用户
- **我想要** 无需注册即可体验核心功能
- **以便** 快速了解应用价值

### 故事 2：登录后保存历史

- **作为** 频繁使用的用户
- **我想要** 登录后保存所有分析历史
- **以便** 随时查看之前分析过的产品

### 故事 3：跨设备同步偏好

- **作为** 多设备用户
- **我想要** 在不同设备上使用相同的分析偏好
- **以便** 获得一致的分析体验

### 故事 4：管理历史记录

- **作为** 登录用户
- **我想要** 删除不需要的历史记录
- **以便** 保持记录列表整洁

## 用例

### 用例 1：未登录用户首次使用

- **参与者**: 新用户
- **前置条件**: 应用已安装，用户未登录
- **主流程**:
  1. 用户打开应用
  2. 直接进入拍照页面（无登录要求）
  3. 用户拍照并分析配料表
  4. 查看分析结果
  5. 系统在结果页显示"登录保存记录"提示
- **后置条件**: 分析完成，但未保存到云端
- **备选流程**: 用户在提示处点击登录

### 用例 2：手机号验证码登录

- **参与者**: 用户
- **前置条件**: 用户点击登录按钮
- **主流程**:
  1. 用户输入手机号
  2. 用户点击"获取验证码"
  3. 系统发送验证码到手机
  4. 用户输入收到的验证码
  5. 用户点击"登录"
  6. 系统验证验证码
  7. 系统生成 JWT token
  8. 系统返回用户信息
  9. 前端保存 token 到 LocalStorage
  10. 跳转到首页或历史记录页
- **后置条件**: 用户已登录
- **备选流程**:
  - 3a. 验证码发送失败 → 显示错误提示
  - 6a. 验证码错误 → 提示重新输入
  - 6b. 验证码过期 → 提示重新获取

### 用例 3：查看历史记录

- **参与者**: 登录用户
- **前置条件**: 用户已登录
- **主流程**:
  1. 用户点击"历史记录"
  2. 系统加载用户的分析历史
  3. 显示历史记录列表
  4. 用户点击某条记录
  5. 显示该记录的详细分析结果
- **后置条件**: 用户查看了历史记录
- **备选流程**:
  - 2a. 用户未登录 → 显示登录引导
  - 2b. 历史记录为空 → 显示空状态提示

### 用例 4：偏好存储与同步

- **参与者**: 登录用户
- **前置条件**: 用户已登录
- **主流程**:
  1. 用户在首页选择分析偏好
  2. 系统保存到 LocalStorage（缓存）
  3. 系统调用 API 更新数据库中的偏好
  4. 数据库更新成功
  5. 用户在另一设备登录
  6. 系统从数据库加载偏好
  7. 前端缓存到 LocalStorage 并应用偏好
- **后置条件**: 偏好已存储到数据库
- **备选流程**:
  - 3a. 网络错误 → 仅保存本地缓存，显示同步失败提示
  - 3b. 后台重试同步（最多 3 次）

## 约束条件

### 技术约束

- 必须使用现有的 Rust + Axum 后端架构
- 必须使用现有的 PostgreSQL 数据库
- JWT token 使用 `jsonwebtoken` crate
- 短信服务使用阿里云或腾讯云 SMS

### 业务约束

- 验证码发送成本需控制（防止恶意请求）
- 用户数据需符合隐私保护法规
- 注销账号需保留 30 天数据（法规要求）

### 法规约束

- 符合《个人信息保护法》
- 用户协议和隐私政策需明确告知
- 注销账号需提供明确入口

## 依赖关系

### 内部依赖

- 依赖现有的 `analyses` 表结构
- 依赖现有的偏好选择组件
- 依赖现有的错误处理机制

### 外部依赖

- 短信服务（阿里云 SMS / 腾讯云 SMS）
- JWT 库（`jsonwebtoken` crate）
- 加密库（`argon2` / `aes-gcm` crate）

## 成功指标

- 注册转化率 > 30%（访问历史记录时的登录转化）
- 登录成功率 > 99%
- 用户留存率（7 天）> 40%
- 历史记录使用率 > 60%（登录用户中）

## 待解决问题

| 问题 | 影响 | 负责人 | 状态 |
|------|------|--------|------|
| 短信服务商选择（阿里云 vs 腾讯云） | 中 | 产品 | 开放 |
| 是否需要支持邮箱登录 | 低 | 产品 | 开放 |
| 历史记录是否需要搜索功能 | 中 | 产品 | 开放 |
| 是否需要收藏夹功能 | 低 | 产品 | 开放 |

## 参考资料

- [JWT 最佳实践](https://jwt.io/introduction)
- [手机号登录安全指南](https://owasp.org/www-community/controls/Blocking_Brute_Force_Attacks)
- 现有文档：`docs/design/technical-design.md`

---

## 变更记录

| 版本 | 日期 | 作者 | 描述 |
|------|------|------|------|
| 1.0 | 2026-01-25 | Claude Code | 初始版本 |
