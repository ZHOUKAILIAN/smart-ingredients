# 004-配料表表格数据联调需求文档

## 元数据

| 字段     | 值                         |
| -------- | -------------------------- |
| 文档编号 | 004-001                    |
| 标题     | 配料表表格数据联调需求文档 |
| 版本     | 1.0                        |
| 状态     | 草稿                       |
| 创建日期 | 2026-01-17                 |
| 更新日期 | 2026-01-17                 |
| 作者     | Codex                      |

## 概述

### 背景

当前服务端已完成图片上传、OCR 识别、LLM 分析等主流程，但返回结构无法满足前端对“配料表格化展示”的数据结构要求，导致前后端联调受阻。

### 目的

新增统一的数据响应结构：先返回配料表的简要概括，再返回可直接渲染的配料表格数据，支撑前后端联调与 UI 展示。

### 范围

**包含**:

- 统一的分析结果响应结构（摘要 + 表格数据）
- 配料表格字段定义与排序规则
- 前后端联调所需的示例数据与错误处理

**不包含**（留待后续）:

- 配料表的高级结构化解析（营养成分表、复杂版式）
- 复杂数据清洗与人工校对流程
- 前端 UI 交互细节设计

### 利益相关者

- 前端开发者（渲染摘要与表格）
- 后端开发者（返回结构化数据）
- 产品/测试人员（验收联调结果）

## 功能需求

### 需求 1：分析结果统一响应结构

- **编号**: FR-INTEG-001
- **优先级**: 高
- **描述**: LLM 分析完成后，返回包含“摘要 + 表格数据”的统一结构
- **验收标准**:
  - [ ] 返回字段包含 `summary` 与 `table` 两部分
  - [ ] `summary` 为 1-3 句话概括配料表主要特点
  - [ ] `table` 为可直接渲染的数组结构

### 需求 2：配料表格字段定义

- **编号**: FR-INTEG-002
- **优先级**: 高
- **描述**: 定义前端期望的表格字段，以便稳定渲染
- **验收标准**:
  - [ ] 每行至少包含 `name`、`category`、`function`、`risk_level`、`note`
  - [ ] `risk_level` 取值为 `low`、`medium`、`high` 或 `unknown`
  - [ ] `note` 支持空字符串
  - [ ] `category` 允许自定义枚举（如“添加剂”“防腐剂”“甜味剂”）

### 需求 3：表格排序与去重

- **编号**: FR-INTEG-003
- **优先级**: 中
- **描述**: 输出的表格数据保持可读性与稳定顺序
- **验收标准**:
  - [ ] 保持与 OCR 文本中的出现顺序一致
  - [ ] 同名配料做去重合并（保留风险更高条目）
  - [ ] 无法识别的配料归类为 `unknown`

### 需求 4：联调示例与错误处理

- **编号**: FR-INTEG-004
- **优先级**: 中
- **描述**: 提供前后端联调所需的示例数据与错误响应
- **验收标准**:
  - [ ] 提供至少 1 份成功响应示例
  - [ ] 提供 OCR 失败与 LLM 失败的错误响应示例
  - [ ] 错误响应包含 `message` 与可读提示

## 非功能需求

### 兼容性

- 保持原有接口字段不被破坏（必要时新增版本或在响应中新增字段）

### 可测试性

- 返回结构可通过前端 mock 数据独立渲染

## 依赖关系

### 内部依赖

- OCR 文本输出稳定性
- LLM 输出结构化能力

### 外部依赖

- 无新增外部依赖

## 成功指标

- [ ] 前端无需额外转换即可渲染配料表格
- [ ] 前后端联调完成，可覆盖成功/失败场景
