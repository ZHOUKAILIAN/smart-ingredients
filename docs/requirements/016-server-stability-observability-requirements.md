# 016-服务端稳定性与可观测性需求文档

## 元数据

| 字段 | 值 |
|------|-----|
| 文档编号 | 016-server-stability-observability |
| 标题 | 服务端稳定性与可观测性需求文档 |
| 版本 | 1.2 |
| 状态 | 草稿 |
| 创建日期 | 2026-01-28 |
| 更新日期 | 2026-01-29 |
| 作者 | Codex |

## 概述

### 目的
建立服务端稳定性保障与可观测性能力，让团队可以及时看到服务端报错并快速定位问题。优先满足单机自建与日志可检索，前期不纳入告警能力。

### 范围
**包含内容**：
- 服务端错误日志采集与聚合（自建）
- 错误趋势与异常定位（基于日志）
- 关键错误指标的趋势展示（基于日志）
- 健康检查与可用性探测
- Grafana OSS + Loki + Promtail 的单机部署与运维

**不包含内容**：
- 业务功能优化或重构
- 云托管监控/日志平台（SaaS）
- 客户端埋点与前端监控
- 告警规则与通知通道（后续阶段）

### 利益相关者
- **运维/开发**：能够及时定位错误与接口异常
- **产品团队**：服务稳定性可量化，可持续改进
- **用户**：减少服务异常对体验的影响

## 功能需求

### 需求 1：错误日志采集与聚合
- **编号**: FR-016-001
- **优先级**: 高
- **描述**: 服务端的异常与错误日志需要统一采集、结构化输出，并可检索（自建 Grafana + Loki）
- **验收标准**:
  - [ ] 错误日志包含请求标识、时间、路由、状态码、错误类型、错误信息与关键上下文
  - [ ] 日志可按服务、时间范围、路由、状态码、错误类型检索
  - [ ] 业务异常与系统异常可区分展示
  - [ ] Promtail 能采集指定日志文件并写入 Loki

### 需求 2：异常可视化与快速定位
- **编号**: FR-016-002
- **优先级**: 高
- **描述**: 服务出现异常时能够通过日志检索与看板快速定位问题（前期不做告警）
- **验收标准**:
  - [ ] 支持按接口或错误类型检索异常日志
  - [ ] 展示最近错误样例与聚合统计

### 需求 3：关键指标监控与可视化
- **编号**: FR-016-003
- **优先级**: 中
- **描述**: 基于日志生成关键错误指标的趋势展示（可选）
- **验收标准**:
  - [ ] 展示错误数、5xx 数、错误率（基于日志统计）
  - [ ] 支持按时间范围查看趋势图
  - [ ] 能区分不同接口的错误指标（按 route 分组）

### 需求 4：健康检查与可用性探测
- **编号**: FR-016-004
- **优先级**: 中
- **描述**: 提供服务健康检查与可用性探测，形成服务可用性基线
- **验收标准**:
  - [ ] 服务提供健康检查接口并返回核心依赖状态
  - [ ] 健康检查结果可被监控系统采集
  - [ ] 可用性低于阈值时可在看板中识别并记录

## 非功能需求

### 可靠性
- 监控系统在服务异常时仍可稳定采集
- 日志采集失败时不影响业务请求处理

### 性能
- 日志与指标采集的额外开销可控，不明显影响业务响应

### 安全
- 日志中不记录敏感信息（如密钥、完整用户隐私数据）

## 用户故事

### 故事 1
- **作为** 服务端维护人员
- **我想要** 能够第一时间看到错误信息并快速定位问题
- **以便** 在问题扩散前快速处理

### 故事 2
- **作为** 产品负责人
- **我想要** 看到服务稳定性指标趋势
- **以便** 评估改进效果与风险

## 用例

### 用例 1：异常发生时的定位响应
- **参与者**: 运维/开发
- **前置条件**: 服务已接入日志与看板
- **主流程**:
  1. 服务出现大量 5xx 或超时错误
  2. 运维打开 Grafana 检索错误日志与样例
  3. 负责人查看错误详情并定位接口与错误类型
- **后置条件**: 确认异常并启动处理流程

### 用例 2：日常稳定性回顾
- **参与者**: 产品/开发
- **前置条件**: 指标已可视化
- **主流程**:
  1. 打开稳定性监控面板
  2. 查看最近一周错误率与错误趋势
  3. 识别异常时间段并定位原因
- **后置条件**: 输出改进项或行动计划

## 约束条件

### 技术约束
- 现有服务端日志输出需保持兼容，逐步切换到结构化日志
- 单机自建部署，所有数据保存在本机 volume/宿主机目录
- Docker 部署需确保 Grafana/Loki 数据持久化，避免重装导致数据丢失

## 依赖关系

### 内部依赖
- 服务端统一日志规范
- 关键接口与任务的指标埋点

### 外部依赖
- Grafana OSS（可视化）
- Loki（日志存储与检索）
- Promtail（日志采集）
- Docker / Docker Compose

## 成功指标

- 错误日志可检索覆盖率达到 100%
- 关键错误定位时间降低到 30 分钟以内
- 关键接口错误趋势可在看板中可视化

## 待解决问题

| 问题 | 影响 | 负责人 | 状态 |
|------|------|--------|------|
| 日志保留时间与磁盘容量上限？ | 中 | 运维/开发 | 开放 |
| 后续是否引入告警能力与通知渠道？ | 低 | 运维/产品 | 开放 |

## 参考资料
