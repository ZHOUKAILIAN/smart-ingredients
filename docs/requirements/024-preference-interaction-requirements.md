# 024-人群定位交互与导航修复需求文档

## 元数据

| 字段 | 值 |
|------|-----|
| 文档编号 | 024-preference-interaction |
| 标题 | 人群定位交互与导航修复需求文档 |
| 版本 | 1.2 |
| 状态 | 草稿 |
| 创建日期 | 2026-02-16 |
| 更新日期 | 2026-02-16 |
| 作者 | 小周 |

## 概述

### 目的
修复人群定位相关的交互问题与导航错误，提升首页与个人中心可达性，确保未选择人群也能顺畅使用核心流程。

### 范围
**包含**：
- 人群定位页（Onboarding）步骤说明的视觉紧凑化
- 人群选择改为可跳过，未选择时默认“普通人群”并持久化
- 保存/跳过人群后的导航回首页
- 底部导航对 query 的正确拼接，避免 404
- 未选择人群时可进入首页/个人中心
- 引导页按账号仅展示一次（服务端为准，本地兜底）
- 全局响应式间距（不同机型高度兼容）
- 历史页加载态与按钮点击 loading

**不包含**：
- 新增人群类型或规则库扩展
- 后端分析逻辑变更
- 重新设计首页或新增新路由

### 利益相关者
- 新用户：不想被强制选择人群即可体验流程
- 现有用户：避免导航异常与 404
- 产品与运营：降低流失，提高完成率

## 功能需求

### 需求 1：人群选择可跳过且默认普通人群
- **编号**: FR-001
- **优先级**: 高
- **描述**: 用户可以不选择人群直接使用应用。若未选择，系统默认“普通人群”，并写入本地与已登录用户的服务端偏好。
- **验收标准**:
  - [ ] 首次进入首页不再强制跳转人群定位页
  - [ ] 未设置人群时，分析流程默认使用“普通人群”
  - [ ] 默认值会写入本地偏好
  - [ ] 已登录用户默认值会同步到服务端偏好

### 需求 2：人群定位页保存/跳过后回首页
- **编号**: FR-002
- **优先级**: 高
- **描述**: 在人群定位页点击“确认人群并开始”或“先体验，后设置”后，导航到首页，不自动进入拍照。
- **验收标准**:
  - [ ] 保存后跳转到 `/`
  - [ ] 跳过后跳转到 `/`
  - [ ] 不再使用 `/?view=scan` 作为默认跳转目标

### 需求 3：人群定位页步骤区紧凑化
- **编号**: FR-003
- **优先级**: 中
- **描述**: “选人群 / 拍配料表 / 看识别结果”等步骤说明改为紧凑版，降低视觉占比，突出人群选择。
- **验收标准**:
  - [ ] 步骤项的标题与描述字体缩小
  - [ ] 步骤项内边距与间距减小
  - [ ] 仍保持可读性与一致的视觉风格

### 需求 4：底部导航 query 拼接修复
- **编号**: FR-004
- **优先级**: 高
- **描述**: 修复底部导航在拼接 query 时遗漏 `?` 的问题，避免出现 `/view=scan` 404。
- **验收标准**:
  - [ ] 当存在 query 时，记录的路径格式为 `/?key=value`
  - [ ] 从个人中心点击首页不再进入 404

### 需求 5：未选择人群可进入个人中心
- **编号**: FR-005
- **优先级**: 高
- **描述**: 未设置人群的情况下，个人中心与首页均可正常进入。
- **验收标准**:
  - [ ] 未设置人群时可进入个人中心
  - [ ] 点击首页可返回首页且不被强制拦截

### 需求 6：引导页仅展示一次（按账号）
- **编号**: FR-006
- **优先级**: 高
- **描述**: 引导页仅在首次进入时展示一次。登录后以服务端标记为准，未登录或服务端无标记时使用本地标记作为兜底；登录后需同步到服务端，确保跨设备不重复展示。
- **验收标准**:
  - [ ] 首次进入时展示引导页
  - [ ] 引导完成/跳过后不再重复展示
  - [ ] 登录后以服务端标记为准，跨设备不重复展示
  - [ ] 未登录时使用本地标记避免重复展示

### 需求 7：全局响应式间距适配不同机型
- **编号**: FR-007
- **优先级**: 高
- **描述**: 统一使用响应式间距（vh/vw + clamp + safe-area），降低不同手机高度差导致的拥挤或过松。
- **验收标准**:
  - [ ] 首页“开始分析”与底部保持安全间距（含 safe-area）
  - [ ] 主要页面上下/左右 padding 使用统一响应式变量
  - [ ] 小屏不拥挤，大屏不松散

### 需求 8：历史页加载态与按钮点击 loading
- **编号**: FR-008
- **优先级**: 高
- **描述**: 历史页列表加载时显示 loading（骨架或全局），按钮点击后显示 loading 并防止重复点击。
- **验收标准**:
  - [ ] 首次进入或分页加载时显示列表 loading
  - [ ] “暂无历史记录”仅在加载完成且无数据时展示
  - [ ] 查看/导出/删除/分页按钮点击后显示 loading 并禁用

## 非功能需求

### 可用性
- 首页与个人中心入口保持可达
- 交互与文案保持清晰一致

### 可靠性
- 导航路径无 404
- 默认人群持久化后流程稳定

## 用户故事

### 故事 1
- **作为** 新用户
- **我想要** 不选择人群也能开始体验
- **以便** 快速了解产品能力

### 故事 2
- **作为** 已登录用户
- **我想要** 偏好默认值自动保存
- **以便** 后续分析不必重复设置

### 故事 3
- **作为** 现有用户
- **我想要** 从个人中心点击首页不会出现 404
- **以便** 顺畅返回首页

### 故事 4
- **作为** 已登录用户
- **我想要** 引导页仅展示一次并跨设备生效
- **以便** 不被重复打断体验

### 故事 5
- **作为** 使用不同尺寸手机的用户
- **我想要** 主要页面间距自动适配
- **以便** 按钮与内容不会挤在一起

### 故事 6
- **作为** 查看历史记录的用户
- **我想要** 加载与操作时有明确反馈
- **以便** 知道系统正在处理

## 用例

### 用例 1：未选择人群直接体验
- **参与者**: 未登录用户
- **前置条件**: 无偏好记录
- **主流程**:
  1. 进入首页
  2. 点击“开始分析”进入拍照
  3. 系统使用默认“普通人群”进行分析
- **后置条件**: 默认偏好已写入本地
- **备选流程**: 用户进入个人中心设置人群

### 用例 2：保存人群并返回首页
- **参与者**: 用户
- **前置条件**: 进入人群定位页
- **主流程**:
  1. 选择人群
  2. 点击“确认人群并开始”
  3. 返回首页
- **后置条件**: 偏好保存成功

### 用例 3：首次引导按账号展示
- **参与者**: 用户
- **前置条件**: 服务端 `has_seen_onboarding` 未设置
- **主流程**:
  1. 进入应用
  2. 系统检查本地标记与服务端标记
  3. 展示引导页
  4. 用户完成/跳过引导
  5. 本地与服务端标记写入完成
- **后置条件**: 后续进入不再展示引导

### 用例 4：历史页加载与操作反馈
- **参与者**: 用户
- **前置条件**: 登录或本地有历史记录
- **主流程**:
  1. 进入历史页
  2. 系统显示 loading 并加载列表
  3. 加载完成后展示数据或空状态
  4. 用户点击查看/导出/删除/分页
  5. 按钮显示 loading，完成后恢复
- **后置条件**: 用户获得明确操作反馈

## 约束条件

### 技术约束
- 前端使用 Leptos + Tauri 现有路由机制
- 不新增新的页面路由

## 依赖关系

### 内部依赖
- `frontend/src/pages/onboarding.rs`
- `frontend/src/pages/capture.rs`
- `frontend/src/components/bottom_nav.rs`
- `frontend/src/pages/history.rs`
- `frontend/src/styles/app.css`
- `frontend/src/utils/local_storage.rs`

## 成功指标

- 首页与个人中心访问成功率 100%
- 人群定位页跳转 0 失败
- `/view=scan` 404 不再出现
- 引导页重复展示率 0（已登录用户）
- 主要页面在不同机型下布局拥挤反馈显著下降
- 历史页加载与操作都有可见反馈

## 待解决问题

| 问题 | 影响 | 负责人 | 状态 |
|------|------|--------|------|
| 默认人群写入时机是否影响体验 | 中 | 小周 | 已解决 |

## 参考资料

- `docs/requirements/013-tab-navigation-and-onboarding-requirements.md`
- `docs/requirements/011-personalized-analysis-requirements.md`

---

## 变更记录

| 版本 | 日期 | 作者 | 描述 |
|------|------|------|------|
| 1.0 | 2026-02-16 | 小周 | 初始版本 |
| 1.1 | 2026-02-16 | 小周 | 增加引导页按账号仅展示一次要求 |
| 1.2 | 2026-02-16 | 小周 | 增加响应式间距与历史页 loading |
