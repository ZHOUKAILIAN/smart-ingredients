# 009-图片上传格式支持优化需求文档

## 元数据

| 字段 | 值 |
|------|-----|
| 文档编号 | 009-image-upload-format-support |
| 标题 | 图片上传格式支持优化需求文档 |
| 版本 | 1.1 |
| 状态 | 草稿 |
| 创建日期 | 2026-01-21 |
| 更新日期 | 2026-01-21 |
| 作者 | Claude Code |

## 概述

### 目的

解决用户拍照上传图片时遇到的格式不支持错误问题。当前系统仅支持 JPEG、PNG、WebP 三种格式，导致某些设备拍摄的照片（如 HEIC、BMP 等格式）无法上传。本需求旨在：

1. **扩展支持的图片格式**：支持所有常见的图片格式
2. **服务端统一处理**：在服务端将所有格式转换为标准格式（JPEG/PNG）
3. **优化错误提示方式**：所有错误使用弹窗/Toast 提示，而非页面底部显示
4. **提升用户体验**：用户无需关心图片格式，拍照即可上传

### 范围

**包含内容**:
- 扩展后端图片格式验证逻辑，支持更多格式
- 实现服务端图片格式转换功能
- **实现全局错误提示组件**：所有 API 错误使用 Toast/弹窗提示
- 优化错误提示信息，提供更友好的反馈
- 确保转换后的图片质量满足 OCR 识别需求
- 更新 API 文档说明支持的格式

**不包含内容**:
- 前端图片格式转换（由服务端统一处理）
- 图片压缩优化（已有功能，不在本需求范围）
- 视频格式支持
- 文档格式（PDF 等）支持

**重要说明**：
- ⚠️ **全局错误处理改进**：本需求同时包含前端全局错误处理的优化，所有 API 接口的错误都应该使用 Toast/弹窗方式提示用户，而不是在页面底部或其他位置静态显示错误信息

### 利益相关者

- 移动端用户（iOS、Android）
- 后端开发团队
- 测试团队

## 功能需求

### 需求 1：扩展支持的图片格式

- **编号**: FR-001
- **优先级**: 高
- **描述**: 扩展 `validate_content_type` 函数，支持所有常见的图片格式，包括但不限于：
  - JPEG/JPG (image/jpeg)
  - PNG (image/png)
  - WebP (image/webp)
  - HEIC/HEIF (image/heic, image/heif) - iOS 设备默认格式
  - BMP (image/bmp)
  - GIF (image/gif) - 仅取第一帧
  - TIFF (image/tiff)
  - SVG (image/svg+xml) - 需要光栅化
- **验收标准**:
  - [ ] 所有列出的格式都能通过验证
  - [ ] 不支持的格式返回明确的错误信息
  - [ ] 错误信息包含支持的格式列表

### 需求 2：服务端图片格式转换

- **编号**: FR-002
- **优先级**: 高
- **描述**: 在服务端实现图片格式转换功能，将所有上传的图片统一转换为 JPEG 或 PNG 格式存储
- **验收标准**:
  - [ ] 非标准格式（HEIC、BMP、TIFF 等）自动转换为 JPEG
  - [ ] PNG 格式保持不变（保留透明通道）
  - [ ] GIF 格式提取第一帧转换为 JPEG
  - [ ] SVG 格式光栅化为 PNG（指定尺寸）
  - [ ] 转换后的图片质量满足 OCR 识别要求
  - [ ] 转换失败时返回清晰的错误信息

### 需求 3：优化错误提示体验

- **编号**: FR-003
- **优先级**: 高
- **描述**: 优化图片上传失败时的错误提示信息和展示方式，提供更友好和直观的用户反馈
- **验收标准**:
  - [ ] 使用弹窗（Toast/Alert）方式显示错误，而不是在页面底部显示
  - [ ] 错误提示自动消失（3-5 秒）或用户可手动关闭
  - [ ] 格式不支持错误：显示"不支持该图片格式，请选择 JPEG、PNG 或 HEIC 格式的照片"
  - [ ] 文件过大错误：显示"图片文件过大（当前 12.5MB），请选择小于 10MB 的图片"
  - [ ] 转换失败错误：显示"图片处理失败，请重新拍照或选择其他图片"
  - [ ] 网络错误：显示"上传失败，请检查网络连接后重试"
  - [ ] 所有错误信息使用简洁友好的中文，避免技术术语
  - [ ] 错误提示包含可操作的建议（如"重新拍照"、"选择其他图片"）

### 需求 4：保持图片质量

- **编号**: FR-004
- **优先级**: 高
- **描述**: 确保格式转换过程不会显著降低图片质量，影响 OCR 识别准确率
- **验收标准**:
  - [ ] JPEG 转换质量设置为 90 或以上
  - [ ] PNG 转换保持无损压缩
  - [ ] 转换后图片分辨率不低于原图
  - [ ] OCR 识别准确率不因格式转换而下降

### 需求 5：全局错误提示 UI 组件

- **编号**: FR-005
- **优先级**: 高
- **描述**: 实现前端全局错误提示组件，统一处理所有 API 接口的错误反馈，以友好的方式向用户展示错误信息
- **验收标准**:
  - [ ] 实现 Toast 通知组件（轻量级、非阻塞）
  - [ ] 错误提示显示在屏幕顶部或中央（易于注意）
  - [ ] 提示自动消失（3-5 秒），或提供关闭按钮
  - [ ] 支持不同类型的提示（错误、警告、成功、信息）
  - [ ] 错误图标 + 文字说明 + 操作建议
  - [ ] 适配移动端和桌面端显示
  - [ ] 与 Figma UI 设计风格保持一致（品牌绿色、圆角、阴影）
  - [ ] **全局拦截所有 API 错误**：自动将 HTTP 错误转换为 Toast 提示
  - [ ] 移除所有页面底部或静态位置的错误信息显示
  - [ ] 支持错误堆叠（多个错误依次显示）

### 需求 6：性能优化

- **编号**: FR-006
- **优先级**: 中
- **描述**: 确保图片格式转换不会显著增加上传和处理时间
- **验收标准**:
  - [ ] 格式转换时间不超过 2 秒（10MB 图片）
  - [ ] 转换过程使用流式处理，避免内存溢出
  - [ ] 支持并发转换（多个用户同时上传）

## 非功能需求

### 性能

- 格式转换响应时间：< 2 秒（10MB 图片）
- 内存占用：单次转换不超过 100MB
- 并发支持：至少支持 10 个并发转换任务

### 兼容性

- 支持主流移动设备拍摄的图片格式
- 兼容 iOS 11+ 的 HEIC 格式
- 兼容 Android 各版本的默认相机格式
- 支持主流浏览器的文件选择器

### 可靠性

- 格式转换失败率 < 1%
- 转换失败时不影响系统其他功能
- 提供详细的错误日志用于问题排查

### 安全性

- 验证上传文件确实是图片格式（防止伪装攻击）
- 限制单个文件最大尺寸（10MB）
- 防止恶意构造的图片文件导致服务崩溃

## 用户故事

### 故事 1

- **作为** iOS 用户
- **我想要** 直接上传 iPhone 拍摄的 HEIC 格式照片
- **以便** 无需手动转换格式即可分析配料表

### 故事 2

- **作为** Android 用户
- **我想要** 上传任意格式的图片（包括从其他应用保存的 BMP、TIFF 等）
- **以便** 灵活使用不同来源的图片进行分析

### 故事 3

- **作为** 用户
- **我想要** 在上传失败时看到清晰的错误提示
- **以便** 知道问题原因并采取正确的解决方法

## 用例

### 用例 1：iOS 用户上传 HEIC 格式照片

- **参与者**: iOS 用户
- **前置条件**:
  - 用户已打开应用
  - 用户使用 iPhone 拍摄了配料表照片（HEIC 格式）
- **主流程**:
  1. 用户点击拍照按钮
  2. 用户拍摄配料表照片
  3. 系统上传 HEIC 格式图片到服务端
  4. 服务端验证格式（HEIC 支持）
  5. 服务端将 HEIC 转换为 JPEG
  6. 转换后的 JPEG 图片存储到磁盘
  7. 返回上传成功响应
  8. 启动 OCR 识别流程
- **后置条件**: 图片已成功上传并开始 OCR 识别
- **备选流程**:
  - 如果转换失败，返回错误信息并提示用户重试
  - 如果文件过大，返回文件大小限制错误

### 用例 2：用户上传不支持的格式

- **参与者**: 用户
- **前置条件**:
  - 用户已打开应用
  - 用户选择了一个非图片文件（如 PDF）
- **主流程**:
  1. 用户选择文件上传
  2. 系统上传文件到服务端
  3. 服务端验证格式（不支持）
  4. 返回错误响应："不支持的文件格式，请上传图片文件（支持 JPEG、PNG、HEIC、BMP 等格式）"
  5. 前端显示错误提示
- **后置条件**: 用户了解到格式不支持，可以重新选择正确的文件
- **备选流程**: 无

## 约束条件

### 技术约束

- 必须使用 Rust 生态的图片处理库（如 `image` crate）
- 转换后的图片必须兼容现有的 OCR 预处理流程
- 不能破坏现有的图片存储逻辑
- 需要考虑跨平台兼容性（macOS、Linux、Windows）

### 业务约束

- 实现必须快速完成，不影响其他功能开发
- 不能引入过多的外部依赖
- 必须保持 API 接口的向后兼容性

### 性能约束

- 格式转换不能成为性能瓶颈
- 内存占用必须可控
- 支持并发处理多个上传请求

## 依赖关系

### 内部依赖

- `backend/src/handlers/analysis.rs` - 上传处理逻辑
- `backend/src/services/storage.rs` - 图片存储服务
- `backend/src/services/ocr_preprocess.rs` - OCR 预处理（需要兼容）
- `backend/src/errors.rs` - 错误类型定义

### 外部依赖

- `image` crate - Rust 图片处理库
- `opencv` (可选) - 用于 SVG 光栅化
- 文件系统 - 临时文件存储

## 问题分析

### 当前问题

1. **格式限制过严**:
   - **根本原因**: `validate_content_type` 函数仅支持 3 种格式
   - **影响**: iOS HEIC、BMP、TIFF 等格式无法上传

2. **错误提示不友好**:
   - **根本原因**: 错误信息为英文且不够具体
   - **影响**: 用户不知道如何解决问题

3. **缺少格式转换**:
   - **根本原因**: 后端直接存储原始格式，未做统一处理
   - **影响**: 某些格式可能不兼容 OCR 预处理

### 解决方案

1. **扩展格式支持**:
   - 更新 `validate_content_type` 函数，添加更多格式
   - 使用 `image` crate 自动检测图片格式

2. **实现格式转换**:
   - 在 `storage::store_image` 中添加格式转换逻辑
   - 统一转换为 JPEG（有损）或 PNG（无损）

3. **优化错误提示**:
   - 使用中文错误信息
   - 提供具体的支持格式列表和解决建议

4. **测试验证**:
   - 在真实设备上测试 HEIC 格式
   - 测试各种边界情况（超大图片、损坏的图片等）

## 技术方案概要

### 方案 1：使用 `image` crate（推荐）

```rust
use image::{ImageFormat, DynamicImage};

fn convert_to_standard_format(
    bytes: &[u8],
    format: ImageFormat,
) -> Result<Vec<u8>> {
    let img = image::load_from_memory_with_format(bytes, format)?;

    let mut output = Vec::new();
    // 转换为 JPEG (质量 90)
    img.write_to(&mut output, ImageFormat::Jpeg)?;

    Ok(output)
}
```

**优点**:
- 纯 Rust 实现，无需外部依赖
- 支持大部分常见格式
- 性能良好，内存安全

**缺点**:
- 不支持 HEIC 格式（需要额外的 crate）
- SVG 支持有限

### 方案 2：使用 `libheif` + `image` crate

对于 HEIC 格式，使用 `libheif-rs` 或 `libheif-sys` 进行解码，然后用 `image` crate 进行转换。

**优点**:
- 完整支持 HEIC/HEIF 格式
- 解码质量高

**缺点**:
- 需要系统安装 `libheif` 库
- 跨平台部署复杂度增加

## 成功指标

- [ ] 支持至少 8 种常见图片格式
- [ ] HEIC 格式上传成功率 > 95%
- [ ] 格式转换平均时间 < 1.5 秒
- [ ] OCR 识别准确率不下降
- [ ] 用户反馈格式错误问题减少 > 80%
- [ ] 系统稳定性不受影响（无崩溃、无内存泄漏）

## 待解决问题

| 问题 | 影响 | 负责人 | 状态 |
|------|------|--------|------|
| HEIC 格式支持需要外部库 | 高 | 后端团队 | 开放 |
| SVG 光栅化方案选择 | 中 | 后端团队 | 开放 |
| 格式转换的内存占用控制 | 中 | 后端团队 | 开放 |
| 是否需要支持动图（GIF、APNG） | 低 | 产品团队 | 开放 |

## 参考资料

- [image crate 文档](https://docs.rs/image/)
- [libheif-rs](https://github.com/Cykooz/libheif-rs)
- [HEIC 格式规范](https://en.wikipedia.org/wiki/High_Efficiency_Image_File_Format)
- [Rust 图片处理最佳实践](https://www.lpalmieri.com/posts/image-processing-rust/)
- 现有需求文档：
  - 001-mobile-ui-requirements.md
  - project-requirements.md

---

## 变更记录

| 版本 | 日期 | 作者 | 描述 |
|------|------|------|------|
| 1.0 | 2026-01-21 | Claude Code | 初始版本，定义图片上传格式支持优化需求 |
| 1.1 | 2026-01-21 | Claude Code | 添加全局错误提示需求（FR-005），强调所有 API 错误使用 Toast 提示 |
