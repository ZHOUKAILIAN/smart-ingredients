# 030-OCR 空结果失败提示 需求文档

## 元数据

| 字段 | 值 |
|------|-----|
| 文档编号 | 030-ocr-empty-result |
| 标题 | OCR 空结果失败提示 需求文档 |
| 版本 | 1.0 |
| 状态 | 草稿 |
| 创建日期 | 2026-02-21 |
| 更新日期 | 2026-02-21 |
| 作者 | Codex |

## 概述

### 目的
解决 OCR 服务在无识别结果时抛出 500 的问题，改为明确返回“识别为空”的业务失败，并让前端获得可读提示。

### 范围
- 仅覆盖 OCR 空结果的错误处理与提示。
- 不改变正常识别流程与结果结构。
- 不新增前端交互改动。

### 利益相关者
- 终端用户（需要明确的失败提示）
- 后端服务维护者（需要稳定可观测的错误语义）

## 功能需求

### 需求 1：OCR 空结果返回业务失败
- **编号**: FR-030-001
- **优先级**: 高
- **描述**: OCR 服务在识别结果为空（无文本）时返回 HTTP 422，并提供可读错误信息。
- **验收标准**:
  - [ ] 空白或无法识别的图片触发 OCR 服务返回 422。
  - [ ] 返回体包含可读 `message` 字段（例如“未识别到文字，请重新拍摄或上传更清晰的图片”）。
  - [ ] 不再出现 `NoneType` 遍历导致的 500。

### 需求 2：后端透传友好提示
- **编号**: FR-030-002
- **优先级**: 高
- **描述**: 后端在收到 OCR 422 时，将提示信息写入分析记录的 `error_message` 并标记 `ocr_failed`。
- **验收标准**:
  - [ ] OCR 返回 422 时，分析状态变为 `ocr_failed`。
  - [ ] `error_message` 为 OCR 响应中的 `message`（若缺失则使用默认提示）。
  - [ ] 其他非 2xx 仍按依赖失败处理。

## 非功能需求

### 可靠性
- OCR 空结果不应导致服务崩溃或 500。

### 兼容性
- 现有成功路径响应结构保持不变。

## 用户故事

### 故事 1
- **作为** 用户
- **我想要** 在 OCR 识别失败时看到明确提示
- **以便** 知道需要重新拍摄或上传更清晰图片

## 用例

### 用例 1：空结果 OCR
- **参与者**: 用户
- **前置条件**: 上传图片
- **主流程**:
  1. OCR 服务识别图片
  2. 发现无可用文本
  3. OCR 返回 422 + message
  4. 后端记录 `ocr_failed` 和提示信息
- **后置条件**: 前端查询到明确错误提示

## 约束条件

### 技术约束
- OCR 服务为 FastAPI + PaddleOCR
- 后端 OCR 调用为 `backend/src/services/ocr.rs`

## 成功指标
- OCR 空结果不再触发 500
- 用户能收到清晰失败提示

## 待解决问题

| 问题 | 影响 | 负责人 | 状态 |
|------|------|--------|------|
| 空结果默认提示文案是否需要产品确认 | 低 | 产品/设计 | 开放 |

## 变更记录

| 版本 | 日期 | 作者 | 描述 |
|------|------|------|------|
| 1.0 | 2026-02-21 | Codex | 初始版本 |
