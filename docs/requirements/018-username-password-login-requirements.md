# 018-账号密码登录需求文档

## 元数据

| 字段 | 值 |
|------|-----|
| 文档编号 | 018-username-password-login |
| 标题 | 账号密码登录需求文档 |
| 版本 | 1.0 |
| 状态 | 草稿 |
| 创建日期 | 2026-01-31 |
| 更新日期 | 2026-01-31 |
| 作者 | Codex |

## 概述

### 目的

将现有登录方式调整为“账号 + 密码”的本地登录体系，不依赖手机号或邮箱验证码，满足个人项目无外部资质的条件。

### 范围

**包含**：
- 账号注册（自定义账号 + 密码）
- 账号登录（账号 + 密码）
- 登录态与 token 机制沿用现有实现
- 用户展示字段统一为 `login_id`

**不包含**：
- 手机号登录
- 邮箱验证码登录
- 密码找回
- 第三方登录（微信/Apple/Google）
- 账号绑定/解绑

### 利益相关者

- **终端用户**：需要简单直观的账号登录方式
- **开发者**：希望不依赖短信/邮件服务
- **运维**：希望减少外部依赖与成本

## 约束与说明

- 该方案**不提供密码找回**能力，用户遗忘密码只能重新注册账号
- 账号需全局唯一，不允许重复
- 密码必须安全哈希存储（Argon2id 或 bcrypt）

## 功能需求

### 需求 1：账号注册

- **编号**: FR-001
- **优先级**: 高
- **描述**: 用户可通过账号 + 密码注册新账户
- **验收标准**:
  - [ ] 账号格式合法（建议仅限字母/数字/下划线）
  - [ ] 账号唯一，不可重复
  - [ ] 密码满足最小强度（长度 >= 8）
  - [ ] 注册成功后返回 access/refresh token

### 需求 2：账号登录

- **编号**: FR-002
- **优先级**: 高
- **描述**: 用户通过账号 + 密码登录
- **验收标准**:
  - [ ] 账号或密码错误时返回明确提示
  - [ ] 登录成功后返回 access/refresh token
  - [ ] token 刷新逻辑保持现有行为

### 需求 3：登录态与权限保持

- **编号**: FR-003
- **优先级**: 高
- **描述**: 登录后行为保持现有体系（偏好同步、历史迁移等）
- **验收标准**:
  - [ ] 登录后可访问需要鉴权的接口
  - [ ] 偏好同步与历史迁移流程不受影响

### 需求 4：统一用户展示字段

- **编号**: FR-004
- **优先级**: 中
- **描述**: 用户信息统一展示为 `login_id`
- **验收标准**:
  - [ ] `UserProfile` 返回 `login_id`
  - [ ] UI 中不再展示手机号字段

### 需求 5：登录安全与限流

- **编号**: FR-005
- **优先级**: 中
- **描述**: 防止暴力破解与撞库攻击
- **验收标准**:
  - [ ] 登录失败次数限制
  - [ ] IP/账号维度限流（可复用 Redis）
  - [ ] 锁定期间返回统一提示

## 数据与接口要求

### 数据模型

新增字段（建议在 users 表）：
- `username`（账号原始值）
- `username_normalized`（用于唯一性判断，统一小写）
- `password_hash`（Argon2id/bcrypt）
- `password_updated_at`（可选）

说明：原手机号字段可保留但不再使用。

### 接口设计

- `POST /api/v1/auth/register`
  - 请求：`{ username: string, password: string }`
  - 响应：`{ access_token, refresh_token, expires_in, user }`

- `POST /api/v1/auth/login`
  - 请求：`{ username: string, password: string }`
  - 响应：`{ access_token, refresh_token, expires_in, user }`

- `POST /api/v1/auth/logout`（沿用）
- `POST /api/v1/auth/refresh`（沿用）

## 非功能需求

### 安全性

- 密码必须安全哈希存储（Argon2id 或 bcrypt）
- 不在日志中记录明文密码
- 登录接口需要限流与失败锁定

### 性能

- 登录接口响应 < 500ms
- 注册接口响应 < 800ms

### 可靠性

- 登录成功率 > 99.9%
- token 刷新成功率 > 99%

## 迁移与兼容

- 前端移除手机号/邮箱登录入口
- 后端保留原短信/邮箱接口但不再调用（后续可删除）
- 现有用户数据保留（不影响历史记录与偏好数据）

## 风险与对策

- **风险**：用户忘记密码无法找回
  - **对策**：登录页明确提示“无法找回密码，仅可重新注册”

- **风险**：弱密码导致撞库风险
  - **对策**：提升密码强度要求 + 登录限流

## 验收标准（汇总）

- [ ] 账号注册成功并返回 token
- [ ] 账号登录成功并返回 token
- [ ] 登录态可访问受限接口
- [ ] token 刷新逻辑可用
- [ ] UI 无手机号/邮箱登录入口
- [ ] 登录限流/锁定机制生效
