# 003-接口自动化测试框架需求文档

## 元数据

| 字段 | 值 |
|------|-----|
| 文档编号 | 003-001 |
| 标题 | 接口自动化测试框架需求文档 |
| 版本 | 1.0 |
| 状态 | 草稿 |
| 创建日期 | 2026-01-17 |
| 更新日期 | 2026-01-17 |
| 作者 | Claude |

## 概述

### 目的
搭建一套可复用、可扩展的接口自动化测试框架，用于验证后端 API 的功能、稳定性与回归质量，并支持持续集成中的自动执行。

### 范围
**包含**:
- API 自动化测试工程结构与脚手架
- 测试用例组织方式（分层/分组）
- 统一的配置管理（环境、账号、密钥、服务地址）
- 请求/响应封装与断言规范
- 测试数据准备与清理机制
- 报告输出与日志收集
- CI 集成方案（如 GitHub Actions 或本地脚本）

**不包含**（留待后续）:
- UI 自动化测试
- 性能压测（如压力/吞吐）
- 安全测试（如漏洞扫描）
- 监控告警平台接入

### 利益相关者
- 后端开发者（验证 API 正确性）
- 前端开发者（回归接口变更）
- 测试/产品（质量保证）

## 功能需求

### 需求 1：测试框架初始化
- **编号**: FR-API-001
- **优先级**: 高
- **描述**: 提供可直接运行的接口自动化测试框架基础结构
- **验收标准**:
  - [ ] 包含统一的测试入口与目录结构
  - [ ] 支持本地一键执行全部用例
  - [ ] 提供示例用例与 README 指引

### 需求 2：环境与配置管理
- **编号**: FR-API-002
- **优先级**: 高
- **描述**: 支持多环境配置（本地、测试、预发、生产）
- **验收标准**:
  - [ ] 可通过 `.env` 或配置文件切换环境
  - [ ] 支持配置 API Base URL、超时、鉴权信息
  - [ ] 配置不提交敏感信息到仓库

### 需求 3：请求封装与断言规范
- **编号**: FR-API-003
- **优先级**: 高
- **描述**: 提供统一的请求封装与断言规范，提升用例可读性
- **验收标准**:
  - [ ] 支持 GET/POST/PUT/DELETE 等常用方法
  - [ ] 支持 JSON、multipart/form-data 等请求类型
  - [ ] 提供统一的响应断言（状态码、字段、结构）

### 需求 4：测试数据准备与清理
- **编号**: FR-API-004
- **优先级**: 中
- **描述**: 用例执行前后支持数据构建和清理
- **验收标准**:
  - [ ] 支持调用数据库或 API 准备测试数据
  - [ ] 支持用例执行后清理数据
  - [ ] 数据构建与清理逻辑可复用

### 需求 5：测试报告与日志
- **编号**: FR-API-005
- **优先级**: 中
- **描述**: 生成清晰的测试报告与详细日志
- **验收标准**:
  - [ ] 输出测试汇总（通过/失败/跳过）
  - [ ] 失败用例提供详细断言信息
  - [ ] 支持导出 HTML 或 JSON 报告

### 需求 6：持续集成执行
- **编号**: FR-API-006
- **优先级**: 中
- **描述**: 在 CI 中自动运行接口测试
- **验收标准**:
  - [ ] 提供 CI 执行脚本或配置示例
  - [ ] 支持环境变量注入
  - [ ] 可在拉取请求/合并时触发

## 用例

### 用例 1：上传接口测试
- **参与者**: 自动化测试框架
- **前置条件**: 后端服务可访问
- **主流程**:
  1. 构建 multipart/form-data 请求上传图片
  2. 断言返回状态码与 `analysis_id`
  3. 记录返回值供后续用例使用
- **后置条件**: 获得可用于后续测试的 ID

### 用例 2：分析流程测试
- **参与者**: 自动化测试框架
- **前置条件**: 已存在 `analysis_id`
- **主流程**:
  1. 调用分析接口触发 OCR + LLM
  2. 查询分析结果
  3. 校验返回结构与字段
- **后置条件**: 结果结构符合预期

## 约束条件

### 技术约束
- 需要与当前后端 API 兼容（Rust + Axum）
- 支持 Docker 或本地运行
- 兼容主流 CI（GitHub Actions 作为优先目标）

### 业务约束
- 不影响现有后端服务性能
- 测试数据需可清理

## 依赖关系

### 内部依赖
- 后端服务已部署或可在本地启动
- 数据库可用（如需要数据准备）

### 外部依赖
- CI 平台（如 GitHub Actions）
- 可选：报告展示工具（如 Allure/HTML 报告）

## 成功指标

- [ ] 本地一键执行接口测试成功率 > 95%
- [ ] CI 能自动执行并输出报告
- [ ] 新增接口测试用例平均 < 30 分钟
