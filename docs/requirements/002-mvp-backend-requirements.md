# 002-MVP 后端需求文档

## 元数据

| 字段     | 值               |
| -------- | ---------------- |
| 文档编号 | 002-002          |
| 标题     | MVP 后端需求文档 |
| 版本     | 1.0              |
| 状态     | 草稿             |
| 创建日期 | 2026-01-17       |
| 更新日期 | 2026-01-17       |
| 作者     | Claude           |

## 概述

### 目的

实现一个最小可行产品（MVP）版本的后端服务，支持图片上传、OCR 文本提取和基于 LLM 的配料表分析功能。

### 范围

**包含**:

- 图片上传接口（multipart/form-data）
- OCR 文本提取（本地开源，Tesseract）
- 配料表文本处理与 LLM 分析
- DeepSeek LLM 集成（可替换）
- 配料表健康分析
- PostgreSQL 数据持久化
- 基础错误处理

**不包含**（留待完整版）:

- OCR 结果人工校对流程
- Redis 缓存
- 用户认证系统
- 历史记录查询（仅存储）
- 收藏功能

### 利益相关者

- 前端开发者（需要调用 API）
- 测试用户（验证功能可用性）

## 功能需求

### 需求 1：图片上传

- **编号**: FR-MVP-001
- **优先级**: 高
- **描述**: 接收前端上传的配料表图片，保存到本地文件系统，返回图片 URL
- **验收标准**:
  - [ ] 支持 multipart/form-data 上传
  - [ ] 验证文件类型（JPEG, PNG, WebP）
  - [ ] 验证文件大小（< 10MB）
  - [ ] 生成唯一文件名（UUID）
  - [ ] 保存到 `uploads/` 目录
  - [ ] 返回图片访问 URL

### 需求 2：OCR 文本提取

- **编号**: FR-MVP-002
- **优先级**: 高
- **描述**: 对上传图片执行 OCR，提取配料表文本
- **验收标准**:
  - [ ] 使用本地 OCR（Tesseract）提取文本
  - [ ] OCR 失败时返回友好错误
  - [ ] 输出文本长度校验（1-5000 字符）
  - [ ] 与图片 ID 关联
  - [ ] 触发 LLM 分析流程

### 需求 3：DeepSeek LLM 集成

- **编号**: FR-MVP-003
- **优先级**: 高
- **描述**: 调用 DeepSeek API 分析配料表文本，返回健康评分和详细分析
- **验收标准**:
  - [ ] 成功调用 DeepSeek Chat API
  - [ ] 使用结构化 Prompt 获取 JSON 响应
  - [ ] 解析返回的健康评分（0-100）
  - [ ] 解析配料列表和风险等级
  - [ ] 解析警告信息和建议
  - [ ] 处理 API 调用失败情况

### 需求 4：分析结果存储

- **编号**: FR-MVP-004
- **优先级**: 高
- **描述**: 将分析结果保存到 PostgreSQL 数据库
- **验收标准**:
  - [ ] 创建 `analyses` 表
  - [ ] 存储图片 URL、配料文本、分析结果
  - [ ] 记录创建时间和更新时间
  - [ ] 支持通过 ID 查询单条记录

### 需求 5：分析结果查询

- **编号**: FR-MVP-005
- **优先级**: 中
- **描述**: 提供 API 查询已完成的分析结果
- **验收标准**:
  - [ ] 通过分析 ID 查询结果
  - [ ] 返回完整的分析数据
  - [ ] 处理未找到记录的情况

### 需求 6：健康检查

- **编号**: FR-MVP-006
- **优先级**: 中
- **描述**: 提供服务健康检查端点
- **验收标准**:
  - [ ] `/health` 端点返回 200 状态
  - [ ] 检查数据库连接状态
  - [ ] 返回服务版本信息

## 非功能需求

### 性能

- 图片上传响应时间 < 2 秒
- OCR 提取响应时间 < 5 秒
- LLM 分析响应时间 < 15 秒（取决于 DeepSeek API）
- 数据库查询响应时间 < 100ms

### 安全性

- 文件上传大小限制（10MB）
- 文件类型白名单验证
- 环境变量存储 API Key
- 基础的输入验证和 SQL 注入防护

### 可靠性

- 数据库连接池管理
- LLM API 调用超时处理（30 秒）
- 友好的错误提示信息

### 可扩展性

- 模块化设计，便于后续更换 OCR 和 LLM Provider
- 预留用户 ID 字段（未来支持多用户）

## 用例

### 用例 1：完整分析流程

- **参与者**: 前端应用
- **前置条件**: 后端服务已启动，数据库已连接
- **主流程**:
  1. 前端上传图片到 `POST /api/v1/analysis/upload`
  2. 后端保存图片，返回 `analysis_id`
  3. 后端对图片执行 OCR，得到配料表文本
  4. 后端调用 DeepSeek API 分析
  5. 后端保存分析结果到数据库
  6. 前端查询结果 `GET /api/v1/analysis/{id}`
  7. 后端返回完整分析结果
- **后置条件**: 分析结果已保存到数据库
- **备选流程**:
  - 如果图片格式不支持，返回 415 错误
  - 如果 OCR 失败，返回 500 错误并记录日志
  - 如果 LLM API 调用失败，返回 500 错误并记录日志

## 约束条件

### 技术约束

- 使用 Rust + Axum 框架
- 使用 SQLx 进行数据库操作
- 使用 reqwest 调用 DeepSeek API
- 使用 Tesseract 进行 OCR
- PostgreSQL 16.x 数据库

### 业务约束

- MVP 阶段不实现用户认证
- OCR 结果需人工核对，但 MVP 阶段不实现校对流程
- 不实现缓存机制

### 法规约束

- 用户上传的图片数据需符合隐私保护要求（未来考虑）

## 依赖关系

### 内部依赖

- 前端 Leptos 应用（提供图片）
- PostgreSQL 数据库（存储分析结果）

### 外部依赖

- DeepSeek API（LLM 分析服务）
- Tesseract OCR（本地识别）
- 需要有效的 DeepSeek API Key

## 成功指标

- [ ] 前端能成功上传图片并获得 ID
- [ ] OCR 能从图片中提取文本并触发分析
- [ ] DeepSeek API 调用成功率 > 95%
- [ ] 分析结果能正确保存和查询
- [ ] 端到端流程完整可用

## API 设计概览

### 1. 上传图片

```
POST /api/v1/analysis/upload
Content-Type: multipart/form-data

Response 201:
{
  "id": "uuid",
  "image_url": "/uploads/{filename}"
}
```

### 2. OCR 提取并分析

```
POST /api/v1/analysis/{id}/analyze

Response 200:
{
  "id": "uuid",
  "status": "completed",
  "result": { ... }
}
```

### 3. 查询分析结果

```
GET /api/v1/analysis/{id}

Response 200:
{
  "id": "uuid",
  "image_url": "/uploads/...",
  "text": "配料表：...",
  "result": {
    "health_score": 75,
    "ingredients": [...],
    "warnings": [...],
    "recommendation": "..."
  },
  "created_at": "2026-01-17T00:00:00Z"
}
```

### 4. 健康检查

```
GET /health

Response 200:
{
  "status": "ok",
  "database": "connected",
  "version": "0.1.0"
}
```

## 待解决问题

| 问题                    | 影响 | 负责人 | 状态   |
| ----------------------- | ---- | ------ | ------ |
| DeepSeek API Rate Limit | 中   | 开发者 | 待确认 |
| 图片存储路径配置        | 低   | 开发者 | 待确认 |

## 参考资料

- [DeepSeek API 文档](https://platform.deepseek.com/api-docs/)
- [Axum 框架文档](https://docs.rs/axum/)
- [SQLx 文档](https://docs.rs/sqlx/)

---

## 变更记录

| 版本 | 日期       | 作者   | 描述                        |
| ---- | ---------- | ------ | --------------------------- |
| 1.0  | 2026-01-17 | Claude | 初始版本 - MVP 后端需求定义 |
