# 014-本地历史记录存储需求文档

## 元数据

| 字段 | 值 |
|------|-----|
| 文档编号 | 014-local-history-storage |
| 标题 | 本地历史记录存储需求文档 |
| 版本 | 1.0 |
| 状态 | 草稿 |
| 创建日期 | 2026-01-26 |
| 更新日期 | 2026-01-26 |
| 作者 | Claude |

## 概述

### 目的
为未登录用户提供本地历史记录存储功能，提升应用可用性和用户体验。同时为已登录用户提供云端历史记录同步，实现跨设备访问。

### 背景
当前系统存在以下问题：
- 未登录用户无法查看任何历史分析记录
- 用户必须登录才能访问历史功能，降低了应用的即用性
- 缺乏渐进式的功能引导，用户体验不够友好

### 范围
**包含内容**：
- 未登录用户的本地历史记录存储（使用 localStorage）
- 已登录用户的云端历史记录存储（使用后端数据库）
- 登录时本地历史记录迁移到云端
- 历史记录的查看、删除功能
- 本地存储的容量限制和清理机制

**不包含内容**：
- 历史记录的导出功能
- 历史记录的分享功能
- 历史记录的搜索和筛选功能（可作为后续优化）

### 利益相关者
- **未登录用户**：可以立即使用应用并查看历史记录，无需强制登录
- **已登录用户**：享受云端同步，跨设备访问历史记录
- **产品团队**：降低用户流失率，提升用户留存

## 功能需求

### 需求 1：本地历史记录存储
- **编号**: FR-014-001
- **优先级**: 高
- **描述**: 未登录用户的分析结果应自动保存到浏览器的 localStorage 中
- **验收标准**:
  - [ ] 每次完成分析后，自动将分析结果保存到 localStorage
  - [ ] 本地历史记录包含：分析ID、时间戳、健康评分、分析结果摘要
  - [ ] 本地历史记录最多保存 50 条，超出后删除最旧的记录
  - [ ] localStorage 存储失败时有降级处理（如提示用户或忽略）

### 需求 2：本地历史记录查看
- **编号**: FR-014-002
- **优先级**: 高
- **描述**: 未登录用户可以在历史记录页面查看本地保存的分析记录
- **验收标准**:
  - [ ] 历史记录页面显示本地存储的所有记录
  - [ ] 显示分析时间、健康评分等关键信息
  - [ ] 点击记录可以查看完整的分析结果
  - [ ] 支持删除单条本地历史记录
  - [ ] 显示"本地记录"标识，提示用户这是设备本地数据

### 需求 3：云端历史记录存储
- **编号**: FR-014-003
- **优先级**: 高
- **描述**: 已登录用户的分析结果保存到云端数据库，支持跨设备访问
- **验收标准**:
  - [ ] 已登录用户完成分析后，自动保存到云端数据库
  - [ ] 云端历史记录包含：用户ID、分析ID、时间戳、健康评分、完整分析结果
  - [ ] 支持分页查询，每页 20 条
  - [ ] 支持删除云端历史记录

### 需求 4：登录时历史记录迁移
- **编号**: FR-014-004
- **优先级**: 中
- **描述**: 用户登录时，将本地历史记录迁移到云端，并清空本地记录
- **验收标准**:
  - [ ] 用户登录成功后，自动检测本地是否有历史记录
  - [ ] 如果有本地记录，提示用户是否迁移到云端
  - [ ] 用户确认后，批量上传本地记录到云端
  - [ ] 上传成功后，清空本地历史记录
  - [ ] 上传失败时，保留本地记录并提示用户稍后重试

### 需求 5：历史记录数据源切换
- **编号**: FR-014-005
- **优先级**: 高
- **描述**: 根据用户登录状态，自动切换历史记录的数据源
- **验收标准**:
  - [ ] 未登录状态：读取 localStorage 中的历史记录
  - [ ] 已登录状态：从云端 API 获取历史记录
  - [ ] 登录/登出时，自动刷新历史记录页面数据
  - [ ] 数据源切换过程无明显延迟或闪烁

### 需求 6：历史记录容量限制
- **编号**: FR-014-006
- **优先级**: 中
- **描述**: 对本地和云端历史记录设置合理的容量限制
- **验收标准**:
  - [ ] 本地历史记录最多保存 50 条
  - [ ] 云端历史记录最多保存 500 条（可根据用户等级调整）
  - [ ] 超出限制后，自动删除最旧的记录
  - [ ] 删除前给用户提示（仅云端）

## 非功能需求

### 性能
- 本地历史记录读取时间 < 100ms
- 云端历史记录查询时间 < 500ms
- 历史记录迁移操作在 5 秒内完成（50 条记录）

### 安全性
- 本地历史记录不包含敏感用户信息
- 云端历史记录通过用户 token 进行权限验证
- 历史记录删除操作需要二次确认

### 可靠性
- localStorage 写入失败时不影响主流程
- 云端 API 失败时有重试机制（最多 3 次）
- 历史记录迁移失败时保留本地数据

### 可扩展性
- 历史记录数据结构支持未来扩展（如添加新字段）
- 支持未来添加历史记录的搜索、筛选功能

## 用户故事

### 故事 1：未登录用户查看历史
- **作为** 未登录的普通用户
- **我想要** 查看我之前的分析记录
- **以便** 回顾之前分析过的食品信息，而不需要重新拍照分析

### 故事 2：已登录用户跨设备访问
- **作为** 已登录的用户
- **我想要** 在不同设备上查看我的历史记录
- **以便** 随时随地访问我的所有分析数据

### 故事 3：登录后数据迁移
- **作为** 之前使用本地记录的用户
- **我想要** 在登录后将本地记录迁移到云端
- **以便** 不丢失之前的分析数据，并能跨设备访问

## 用例

### 用例 1：未登录用户查看本地历史
- **参与者**: 未登录用户
- **前置条件**: 用户之前至少完成过一次分析
- **主流程**:
  1. 用户点击底部导航栏的"历史"标签
  2. 系统检测用户未登录
  3. 系统从 localStorage 读取历史记录
  4. 系统展示历史记录列表，标注"本地记录"
  5. 用户点击某条记录，查看详细分析结果
- **后置条件**: 用户成功查看本地历史记录
- **备选流程**:
  - 3a. 如果 localStorage 为空，显示"暂无历史记录"
  - 3b. 如果 localStorage 读取失败，显示错误提示

### 用例 2：已登录用户查看云端历史
- **参与者**: 已登录用户
- **前置条件**: 用户已登录
- **主流程**:
  1. 用户点击底部导航栏的"历史"标签
  2. 系统检测用户已登录
  3. 系统调用云端 API 获取历史记录（第 1 页）
  4. 系统展示历史记录列表
  5. 用户可以翻页查看更多记录
  6. 用户点击某条记录，查看详细分析结果
- **后置条件**: 用户成功查看云端历史记录
- **备选流程**:
  - 3a. 如果 API 调用失败，显示错误提示并提供重试按钮
  - 3b. 如果云端无历史记录，显示"暂无历史记录"

### 用例 3：登录后迁移本地历史
- **参与者**: 用户
- **前置条件**: 用户有本地历史记录，且刚刚完成登录
- **主流程**:
  1. 用户完成登录
  2. 系统检测到本地有历史记录
  3. 系统弹出提示："检测到 X 条本地记录，是否迁移到云端？"
  4. 用户点击"迁移"
  5. 系统批量上传本地记录到云端
  6. 系统显示上传进度
  7. 上传完成后，清空本地记录
  8. 系统显示"迁移成功"提示
- **后置条件**: 本地记录已迁移到云端
- **备选流程**:
  - 4a. 用户点击"稍后"，保留本地记录，下次登录时再次提示
  - 5a. 如果上传失败，保留本地记录并提示用户稍后重试

## 技术实现要点

### 本地存储结构
```typescript
interface LocalHistoryItem {
  id: string;              // 分析ID
  timestamp: number;       // 时间戳
  health_score: number;    // 健康评分
  summary: string;         // 分析摘要
  result: AnalysisResult;  // 完整分析结果
}

// localStorage key: "smart-ingredients-history"
// 存储格式: JSON.stringify(LocalHistoryItem[])
```

### 云端 API 接口
- `GET /api/user/history?page=1&limit=20` - 获取历史记录
- `POST /api/user/history` - 保存历史记录
- `DELETE /api/user/history/:id` - 删除历史记录
- `POST /api/user/history/batch` - 批量上传历史记录（用于迁移）

### 数据迁移流程
1. 检测本地历史记录
2. 显示迁移提示弹窗
3. 用户确认后，批量上传
4. 上传成功后清空本地记录
5. 刷新历史记录页面

## 约束条件

### 技术约束
- localStorage 容量限制（通常 5-10MB）
- 浏览器隐私模式下 localStorage 可能不可用
- 跨域限制（不同域名下的 localStorage 不共享）

### 业务约束
- 本地历史记录不能包含敏感信息
- 历史记录迁移必须经过用户确认
- 免费用户云端历史记录有数量限制

### 法规约束
- 符合 GDPR 数据隐私要求
- 用户有权删除自己的历史记录
- 历史记录不得用于非授权的数据分析

## 依赖关系

### 内部依赖
- 用户认证系统（判断登录状态）
- 分析结果数据结构（AnalysisResult）
- 底部导航栏（历史记录入口）

### 外部依赖
- 浏览器 localStorage API
- 后端历史记录 API
- 网络连接（云端历史记录）

## 成功指标

- 未登录用户的历史记录使用率 > 30%
- 本地历史记录迁移成功率 > 95%
- 历史记录页面加载时间 < 500ms
- 用户登录转化率提升 10%（因为可以先体验再登录）

## UI/UX 设计要点

### 历史记录页面
- 未登录状态：显示"本地记录"标签，提示"登录后可跨设备访问"
- 已登录状态：显示"云端记录"标签，支持分页
- 空状态：友好的空状态提示和引导

### 迁移提示弹窗
- 标题："发现本地历史记录"
- 内容："检测到 X 条本地记录，是否迁移到云端以便跨设备访问？"
- 按钮："立即迁移" / "稍后再说"
- 进度条：显示上传进度

### 历史记录卡片
- 显示时间、健康评分、分析摘要
- 支持点击查看详情
- 支持滑动删除（移动端）

## 待解决问题

| 问题 | 影响 | 负责人 | 状态 |
|------|------|--------|------|
| localStorage 容量不足时如何处理？ | 中 | 开发团队 | 开放 |
| 是否需要压缩本地历史记录以节省空间？ | 低 | 开发团队 | 开放 |
| 历史记录迁移失败后的重试策略？ | 中 | 开发团队 | 开放 |
| 是否需要支持历史记录的导出功能？ | 低 | 产品团队 | 开放 |

## 参考资料

- [Web Storage API - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API)
- [localStorage 最佳实践](https://web.dev/storage-for-the-web/)
- 012-用户系统需求文档
- 013-底部导航栏需求文档

---

## 变更记录

| 版本 | 日期 | 作者 | 描述 |
|------|------|------|------|
| 1.0 | 2026-01-26 | Claude | 初始版本 |
